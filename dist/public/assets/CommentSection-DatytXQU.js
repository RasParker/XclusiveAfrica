import{a as W,u as G,r as x,j as e,D as oe,Q as le,B as h,p as de,q as ce,s as me,E as he,h as I,R as xe,M as H,z as Q,A as O,m as $,n as K}from"./index-DnjzDop3.js";import{T as M}from"./textarea-ChWCN1Go.js";import{S as pe,a as ue,b as ge,c as fe,d as f}from"./select-BgAE-lOE.js";import{F as je}from"./flag-D_PcH8BI.js";import{C as U}from"./chevron-up-CD9nw7va.js";import{S as P}from"./send-Baqb8pKh.js";import{H as ve}from"./heart-BIzJO6uv.js";const be=({targetType:p,targetId:D,targetName:y,children:N})=>{const{toast:w}=W(),{user:t}=G(),[u,i]=x.useState(!1),[g,c]=x.useState(!1),[j,S]=x.useState({reason:"",description:"",type:C(p)});function C(v){switch(v){case"post":case"comment":return"content";case"user":return"user";default:return"content"}}const E=async v=>{if(v.preventDefault(),!t){w({title:"Authentication Required",description:"You must be logged in to report content.",variant:"destructive"});return}if(!j.reason){w({title:"Reason Required",description:"Please select a reason for reporting.",variant:"destructive"});return}c(!0);try{if((await fetch("/api/reports",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({type:j.type,reason:j.reason,description:j.description,reported_by:t.id,target_type:p,target_id:D,target_name:y})})).ok)w({title:"Report Submitted",description:"Thank you for reporting this content. We'll review it shortly."}),i(!1),S({reason:"",description:"",type:C(p)});else throw new Error("Failed to submit report")}catch{w({title:"Error",description:"Failed to submit report. Please try again.",variant:"destructive"})}finally{c(!1)}};return e.jsxs(oe,{open:u,onOpenChange:i,children:[e.jsx(le,{asChild:!0,children:N||e.jsxs(h,{variant:"outline",size:"sm",children:[e.jsx(je,{className:"w-4 h-4 mr-2"}),"Report"]})}),e.jsxs(de,{className:"sm:max-w-[425px]",children:[e.jsxs(ce,{children:[e.jsx(me,{children:"Report Content"}),e.jsx(he,{children:"Help us keep the platform safe by reporting inappropriate content or behavior."})]}),e.jsxs("form",{onSubmit:E,className:"space-y-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(I,{htmlFor:"reason",children:"Reason for reporting"}),e.jsxs(pe,{value:j.reason,onValueChange:v=>S(b=>({...b,reason:v})),children:[e.jsx(ue,{children:e.jsx(ge,{placeholder:"Select a reason"})}),e.jsx(fe,{children:p==="user"?e.jsxs(e.Fragment,{children:[e.jsx(f,{value:"harassment",children:"Harassment or bullying"}),e.jsx(f,{value:"spam",children:"Spam behavior"}),e.jsx(f,{value:"impersonation",children:"Impersonation"}),e.jsx(f,{value:"inappropriate_contact",children:"Inappropriate contact"}),e.jsx(f,{value:"other",children:"Other"})]}):e.jsxs(e.Fragment,{children:[e.jsx(f,{value:"inappropriate_content",children:"Inappropriate content"}),e.jsx(f,{value:"copyright_violation",children:"Copyright violation"}),e.jsx(f,{value:"spam",children:"Spam"}),e.jsx(f,{value:"harassment",children:"Harassment or hate speech"}),e.jsx(f,{value:"misinformation",children:"Misinformation"}),e.jsx(f,{value:"other",children:"Other"})]})})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(I,{htmlFor:"description",children:"Additional details (optional)"}),e.jsx(M,{id:"description",placeholder:"Provide any additional context or details...",value:j.description,onChange:v=>S(b=>({...b,description:v.target.value})),rows:3})]}),e.jsxs("div",{className:"flex justify-end space-x-2",children:[e.jsx(h,{type:"button",variant:"outline",onClick:()=>i(!1),children:"Cancel"}),e.jsx(h,{type:"submit",disabled:g,children:g?"Submitting...":"Submit Report"})]})]})]})]})},ye=({commentId:p,username:D,onReply:y,onCancel:N,userAvatar:w,currentUserName:t})=>{const[u,i]=x.useState(""),g=()=>{u.trim()&&(y(p,u),i(""))};return e.jsx("div",{className:"mt-3 px-2 animate-in slide-in-from-top-1 duration-200",children:e.jsxs("div",{className:"flex gap-2",children:[e.jsxs(O,{className:"h-6 w-6 sm:h-8 sm:w-8 flex-shrink-0",children:[e.jsx($,{src:w,alt:t}),e.jsx(K,{className:"text-xs",children:t==null?void 0:t.charAt(0).toUpperCase()})]}),e.jsxs("div",{className:"flex-1 flex gap-3",children:[e.jsx(M,{placeholder:`Reply to ${D}...`,value:u,onChange:c=>i(c.target.value),className:"min-h-[60px] resize-none border-border/20 focus:border-primary/40 text-sm bg-background/50",onKeyDown:c=>{c.key==="Enter"&&(c.metaKey||c.ctrlKey)&&g(),c.key==="Escape"&&N()},autoFocus:!0}),e.jsxs("div",{className:"flex flex-col gap-1",children:[e.jsx(h,{size:"sm",variant:"ghost",onClick:g,disabled:!u.trim(),className:"h-8 w-8 p-0 text-primary hover:text-primary/80 hover:bg-primary/10",children:e.jsx(P,{className:"w-4 h-4"})}),e.jsx(h,{size:"sm",variant:"ghost",onClick:N,className:"h-8 w-8 p-0 text-muted-foreground hover:text-foreground hover:bg-muted",children:"âœ•"})]})]})]})})},Re=({postId:p,initialComments:D,onCommentCountChange:y,creatorId:N,isBottomSheet:w=!1})=>{var L,Y;const{user:t}=G(),{toast:u}=W(),[i,g]=x.useState(D),[c,j]=x.useState(""),[S,C]=x.useState(null),[E,v]=x.useState({}),[b,V]=x.useState("newest"),[R,z]=x.useState(!1);x.useState(!1);const[X,Z]=x.useState(!0),ee=x.useCallback(async()=>{try{const s=await fetch(`/api/posts/${p}/comments`,{credentials:"include"});if(s.ok){const o=(await s.json()).map(n=>{var r,l,m;return{id:n.id.toString(),user:{id:((r=n.user)==null?void 0:r.id.toString())||"1",username:((l=n.user)==null?void 0:l.username)||"Anonymous",avatar:(m=n.user)==null?void 0:m.avatar},content:n.content,likes:n.likes_count||0,liked:!1,createdAt:n.created_at,replies:(n.replies||[]).map(d=>{var k,_,T;return{id:d.id.toString(),user:{id:((k=d.user)==null?void 0:k.id.toString())||"1",username:((_=d.user)==null?void 0:_.username)||"Anonymous",avatar:(T=d.user)==null?void 0:T.avatar},content:d.content,likes:d.likes_count||0,liked:!1,createdAt:d.created_at,replies:[]}})}});g(o),y(o.length)}}catch(s){console.error("Failed to fetch comments:",s)}},[p,y]);xe.useEffect(()=>{ee(),(async()=>{if(N)try{const a=await fetch(`/api/creators/${N}/comments-enabled`,{credentials:"include"});if(a.ok){const o=await a.json();Z(o.comments_enabled)}}catch(a){console.error("Error checking comments enabled:",a)}})()},[p,N]);const se=s=>{const a=new Date(s),n=Math.floor((new Date().getTime()-a.getTime())/(1e3*60*60));return n<1?"Just now":n<24?`${n}h ago`:`${Math.floor(n/24)}d ago`},F=async()=>{var s,a,o,n;if(c.trim())try{const r=await fetch(`/api/posts/${p}/comments`,{method:"POST",headers:{"Content-Type":"application/json"},credentials:"include",body:JSON.stringify({content:c})});if(r.ok){const l=await r.json(),m={id:l.id.toString(),user:{id:((s=l.user)==null?void 0:s.id.toString())||((a=t==null?void 0:t.id)==null?void 0:a.toString())||"1",username:((o=l.user)==null?void 0:o.username)||(t==null?void 0:t.username)||"current_user",avatar:((n=l.user)==null?void 0:n.avatar)||(t==null?void 0:t.avatar)},content:l.content,likes:0,liked:!1,createdAt:l.created_at,replies:[]};g(d=>{const k=[m,...d];return y(k.length),k}),j(""),u({title:"Comment added",description:"Your comment has been posted successfully."})}else throw new Error("Failed to post comment")}catch{u({title:"Error",description:"Failed to post comment. Please try again."})}},te=async(s,a)=>{var o,n,r,l;if(a.trim())try{const m=await fetch(`/api/posts/${p}/comments`,{method:"POST",headers:{"Content-Type":"application/json"},credentials:"include",body:JSON.stringify({content:a,parent_id:parseInt(s)})});if(m.ok){const d=await m.json(),k={id:d.id.toString(),user:{id:((o=d.user)==null?void 0:o.id.toString())||((n=t==null?void 0:t.id)==null?void 0:n.toString())||"1",username:((r=d.user)==null?void 0:r.username)||(t==null?void 0:t.username)||"current_user",avatar:((l=d.user)==null?void 0:l.avatar)||(t==null?void 0:t.avatar)},content:d.content,likes:0,liked:!1,createdAt:d.created_at,replies:[]};g(_=>{const T=_.map(A=>A.id===s?{...A,replies:[k,...A.replies]}:A),ne=T.reduce((A,ie)=>A+1+ie.replies.length,0);return y(ne),T}),C(null),u({title:"Reply added",description:"Your reply has been posted successfully."})}else throw new Error("Failed to post reply")}catch(m){console.error("Failed to add reply:",m),u({title:"Error",description:"Failed to post reply. Please try again.",variant:"destructive"})}},re=(s,a=!1,o)=>{g(a&&o?n=>n.map(r=>r.id===o?{...r,replies:r.replies.map(l=>l.id===s?{...l,liked:!l.liked,likes:l.liked?l.likes-1:l.likes+1}:l)}:r):n=>n.map(r=>r.id===s?{...r,liked:!r.liked,likes:r.liked?r.likes-1:r.likes+1}:r))},ae=s=>{v(a=>({...a,[s]:!a[s]}))},q=()=>{const s=[...i];switch(b){case"newest":return s.sort((a,o)=>new Date(o.createdAt).getTime()-new Date(a.createdAt).getTime());case"oldest":return s.sort((a,o)=>new Date(a.createdAt).getTime()-new Date(o.createdAt).getTime());case"popular":return s.sort((a,o)=>o.likes-a.likes);default:return s}},J=R?q():q().slice(0,5),B=({comment:s,depth:a=0,parentId:o,maxDepth:n=3})=>{const r=a>0,l=a<n;return e.jsxs("div",{className:`${r?"ml-6 sm:ml-8 border-l border-border/30 pl-3 sm:pl-4 relative":""}`,children:[r&&e.jsx("div",{className:"absolute left-0 top-4 w-3 sm:w-4 h-0.5 bg-border/30"}),e.jsxs("div",{className:"flex gap-3 py-2",children:[e.jsxs(O,{className:`${r?"h-6 w-6 sm:h-7 sm:w-7":"h-8 w-8"} flex-shrink-0`,children:[e.jsx($,{src:s.user.avatar,alt:s.user.username}),e.jsx(K,{className:"text-xs",children:s.user.username.charAt(0).toUpperCase()})]}),e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsx("div",{className:"mb-1",children:e.jsxs("p",{className:"text-sm leading-relaxed break-words",children:[e.jsx("span",{className:"font-medium text-foreground",children:s.user.username})," ",e.jsx("span",{className:"text-foreground",children:s.content})]})}),e.jsxs("div",{className:"flex items-center gap-4 text-xs text-muted-foreground",children:[e.jsx("span",{children:se(s.createdAt)}),s.likes>0&&e.jsxs("span",{className:"font-medium",children:[s.likes," ",s.likes===1?"like":"likes"]}),l&&e.jsx(h,{variant:"ghost",size:"sm",className:"h-auto p-0 text-muted-foreground hover:text-foreground text-xs font-medium",onClick:()=>C(S===s.id?null:s.id),children:"Reply"}),e.jsx(h,{variant:"ghost",size:"sm",className:`h-auto p-0 hover:text-foreground ${s.liked?"text-red-500":"text-muted-foreground"}`,onClick:()=>re(s.id,r,o),children:e.jsx(ve,{className:`w-3 h-3 ${s.liked?"fill-current":""}`})}),e.jsx(be,{contentId:s.id,contentType:"comment"})]}),!r&&s.replies.length>0&&e.jsxs(h,{variant:"ghost",size:"sm",className:"h-auto p-0 text-muted-foreground hover:text-foreground text-xs font-medium mt-2",onClick:()=>ae(s.id),children:[E[s.id]?"â€” Hide":"â€”â€” View"," ",s.replies.length," ",s.replies.length===1?"reply":"replies"]}),S===s.id&&e.jsx(ye,{commentId:s.id,username:s.user.username,onReply:te,onCancel:()=>C(null),userAvatar:t==null?void 0:t.avatar,currentUserName:t==null?void 0:t.username}),!r&&E[s.id]&&s.replies.length>0&&e.jsx("div",{className:"mt-3 animate-in slide-in-from-top-1 duration-300",children:s.replies.sort((m,d)=>new Date(m.createdAt).getTime()-new Date(d.createdAt).getTime()).map(m=>e.jsx(B,{comment:m,depth:a+1,parentId:s.id,maxDepth:n},m.id))})]})]})]})};return X?w?e.jsxs("div",{className:"w-full h-full bg-background flex flex-col",children:[i.length>0&&e.jsx("div",{className:"px-4 py-3 border-b border-border/20 bg-background shrink-0",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("span",{className:"text-sm font-medium text-foreground",children:[i.length," ",i.length===1?"comment":"comments"]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("span",{className:"text-xs text-muted-foreground hidden sm:inline",children:"Sort by:"}),e.jsxs("select",{value:b,onChange:s=>V(s.target.value),className:"text-xs bg-background border border-border/30 rounded px-2 py-1 text-muted-foreground",children:[e.jsx("option",{value:"newest",children:"Newest"}),e.jsx("option",{value:"oldest",children:"Oldest"}),e.jsx("option",{value:"popular",children:"Most liked"})]})]})]})}),e.jsx("div",{className:"flex-1 overflow-y-auto px-4 bg-background",children:i.length>0?e.jsxs("div",{className:"divide-y divide-border/20",children:[J.map(s=>e.jsx(B,{comment:s},s.id)),i.length>5&&!R&&e.jsx("div",{className:"py-4 text-center border-t border-border/20",children:e.jsxs(h,{variant:"ghost",size:"sm",onClick:()=>z(!0),className:"text-muted-foreground hover:text-foreground text-sm font-medium",children:[e.jsx(Q,{className:"w-4 h-4 mr-1"}),"View ",i.length-5," more comments"]})}),R&&i.length>5&&e.jsx("div",{className:"py-4 text-center border-t border-border/20",children:e.jsxs(h,{variant:"ghost",size:"sm",onClick:()=>z(!1),className:"text-muted-foreground hover:text-foreground text-sm font-medium",children:[e.jsx(U,{className:"w-4 h-4 mr-1"}),"Show fewer comments"]})})]}):e.jsxs("div",{className:"py-8 text-center text-muted-foreground",children:[e.jsx(H,{className:"w-8 h-8 mx-auto mb-2 opacity-50"}),e.jsx("p",{className:"text-sm",children:"No comments yet. Be the first to comment!"})]})}),e.jsx("div",{className:"px-4 py-3 border-t border-border/30 bg-background shrink-0",children:e.jsxs("div",{className:"flex gap-2",children:[e.jsxs(O,{className:"h-8 w-8 flex-shrink-0",children:[e.jsx($,{src:t==null?void 0:t.avatar,alt:t==null?void 0:t.username}),e.jsx(K,{className:"text-xs",children:(L=t==null?void 0:t.username)==null?void 0:L.charAt(0).toUpperCase()})]}),e.jsxs("div",{className:"flex-1 flex gap-3",children:[e.jsx(M,{placeholder:"Add a comment...",value:c,onChange:s=>j(s.target.value),className:"min-h-[40px] max-h-[120px] resize-none border-border/20 focus:border-primary/40 text-sm bg-background",style:{direction:"ltr",textAlign:"left",unicodeBidi:"normal",writingMode:"horizontal-tb",textOrientation:"mixed"},onKeyDown:s=>{s.key==="Enter"&&(s.metaKey||s.ctrlKey)&&F()}}),e.jsx(h,{onClick:F,disabled:!c.trim(),size:"sm",variant:"ghost",className:"h-[40px] px-3 text-primary hover:text-primary/80 hover:bg-primary/10",children:e.jsx(P,{className:"w-4 h-4"})})]})]})})]}):e.jsxs("div",{className:"w-full bg-background",children:[e.jsx("div",{className:"px-2 py-3 border-b border-border/30",children:e.jsxs("div",{className:"flex gap-2",children:[e.jsxs(O,{className:"h-8 w-8 flex-shrink-0",children:[e.jsx($,{src:t==null?void 0:t.avatar,alt:t==null?void 0:t.username}),e.jsx(K,{className:"text-xs",children:(Y=t==null?void 0:t.username)==null?void 0:Y.charAt(0).toUpperCase()})]}),e.jsxs("div",{className:"flex-1 flex gap-3",children:[e.jsx(M,{placeholder:"Add a comment...",value:c,onChange:s=>j(s.target.value),className:"min-h-[60px] resize-none border-border/20 focus:border-primary/40 text-sm bg-background/50",style:{direction:"ltr",textAlign:"left",unicodeBidi:"normal",writingMode:"horizontal-tb",textOrientation:"mixed"},onKeyDown:s=>{s.key==="Enter"&&(s.metaKey||s.ctrlKey)&&F()}}),e.jsx(h,{onClick:F,disabled:!c.trim(),size:"sm",className:"h-[60px] px-3",children:e.jsx(P,{className:"w-4 h-4"})})]})]})}),i.length>0&&e.jsx("div",{className:"px-2 py-3 border-b border-border/20 bg-background/50",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("span",{className:"text-sm font-medium text-foreground",children:[i.length," ",i.length===1?"comment":"comments"]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("span",{className:"text-xs text-muted-foreground hidden sm:inline",children:"Sort by:"}),e.jsxs("select",{value:b,onChange:s=>V(s.target.value),className:"text-xs bg-background border border-border/30 rounded px-2 py-1 text-muted-foreground",children:[e.jsx("option",{value:"newest",children:"Newest"}),e.jsx("option",{value:"oldest",children:"Oldest"}),e.jsx("option",{value:"popular",children:"Most liked"})]})]})]})}),i.length>0?e.jsxs("div",{className:"divide-y divide-border/20",children:[J.map(s=>e.jsx(B,{comment:s},s.id)),i.length>5&&!R&&e.jsx("div",{className:"px-2 py-4 text-center border-t border-border/20",children:e.jsxs(h,{variant:"ghost",size:"sm",onClick:()=>z(!0),className:"text-muted-foreground hover:text-foreground text-sm font-medium",children:[e.jsx(Q,{className:"w-4 h-4 mr-1"}),"View ",i.length-5," more comments"]})}),R&&i.length>5&&e.jsx("div",{className:"px-2 py-4 text-center border-t border-border/20",children:e.jsxs(h,{variant:"ghost",size:"sm",onClick:()=>z(!1),className:"text-muted-foreground hover:text-foreground text-sm font-medium",children:[e.jsx(U,{className:"w-4 h-4 mr-1"}),"Show fewer comments"]})})]}):e.jsxs("div",{className:"px-2 py-8 text-center text-muted-foreground",children:[e.jsx(H,{className:"w-8 h-8 mx-auto mb-2 opacity-50"}),e.jsx("p",{className:"text-sm",children:"No comments yet. Be the first to comment!"})]})]}):e.jsx("div",{className:"w-full bg-background",children:e.jsxs("div",{className:"px-2 py-8 text-center text-muted-foreground",children:[e.jsx(H,{className:"w-8 h-8 mx-auto mb-2 opacity-50"}),e.jsx("p",{className:"text-sm",children:"Comments are disabled for this creator's posts."})]})})};export{Re as C};
