import{v as ae,a as te,b as oe,u as re,r as h,j as e,ab as H,B as b,C as I,d as E,e as L,f as R,g as V,h as W,I as z,a7 as ie,a0 as le,a9 as de}from"./index-DnjzDop3.js";import{T as ne}from"./textarea-ChWCN1Go.js";import{S as ce,a as me,b as he,c as ue,d as G}from"./select-BgAE-lOE.js";import{P as pe,a as xe,f as je,b as ge,C as fe}from"./popover-C4xVhWYM.js";import{z as w,u as ve,F as be,a as N,b as y,e as C,c as S,d as T,t as we}from"./form-ZwPv4Ajc.js";import{A as Ne}from"./arrow-left-DJTbtmZM.js";import{I as ye}from"./image-DUscFDhE.js";import{V as Ce}from"./video-DbSLhckN.js";import{C as Se}from"./calendar-We5RV4OF.js";import{C as Te}from"./clock-DLXk1hVQ.js";import"./chevron-up-CD9nw7va.js";const Fe=w.object({caption:w.string().min(1,"Caption is required").max(2e3,"Caption must be less than 2000 characters"),accessTier:w.string().min(1,"Please select an access tier"),scheduledDate:w.date().optional(),scheduledTime:w.string().optional()}),Be=()=>{const{id:u}=ae(),{toast:v}=te(),x=oe(),{user:i}=re(),[_,A]=h.useState(null),[j,F]=h.useState(null),[D,P]=h.useState(null),[J,U]=h.useState(!0),[k,O]=h.useState(!1),[g,q]=h.useState(null),[Y,B]=h.useState([]),[De,M]=h.useState(null),[Pe,$]=h.useState(null),l=ve({resolver:we(Fe),defaultValues:{caption:"",accessTier:"free",scheduledDate:void 0,scheduledTime:""}}),K=()=>{console.log("Back button clicked"),x("/creator/dashboard")},Q=()=>{console.log("Cancel button clicked"),x("/creator/dashboard")};h.useEffect(()=>{(async()=>{if(!u||!(i!=null&&i.id)){console.log("Missing postId or user.id:",{postId:u,userId:i==null?void 0:i.id}),U(!1);return}try{console.log("Fetching data for post:",u);const[t,n]=await Promise.all([fetch(`/api/posts/${u}`),fetch(`/api/creators/${i.id}/tiers`)]);let a=null,d=[];if(t.ok)a=await t.json(),console.log("Fetched post data:",a);else{console.error("Failed to fetch post data:",t.status),v({title:"Error",description:"Failed to load post data.",variant:"destructive"}),x("/creator/dashboard");return}if(n.ok?(d=await n.json(),B(d),console.log("Fetched tiers data:",d)):(console.error("Failed to fetch tiers"),B([])),a){let c=a.tier==="public"?"free":a.tier;if(c!=="free"&&d.length>0){const r=d.find(f=>f.name.toLowerCase()===c.toLowerCase());r&&(c=r.name)}console.log("Mapped access tier:",c,"from original:",a.tier);let p,m="";if(a.scheduled_for){const r=new Date(a.scheduled_for);p=r;const f=r.getHours().toString().padStart(2,"0"),se=r.getMinutes().toString().padStart(2,"0");m=`${f}:${se}`}const o={caption:a.content||"",accessTier:c,scheduledDate:p,scheduledTime:m};if(console.log("Setting form data:",o),l.setValue("caption",o.caption),l.setValue("accessTier",o.accessTier),o.scheduledDate&&l.setValue("scheduledDate",o.scheduledDate),o.scheduledTime&&l.setValue("scheduledTime",o.scheduledTime),a.media_urls&&a.media_urls.length>0){const r=Array.isArray(a.media_urls)?a.media_urls[0]:a.media_urls,f=r.startsWith("/uploads/")?r:`/uploads/${r}`;console.log("Setting media preview:",f),F(f),P(a.media_type==="image"?"image":"video")}q(a)}}catch(t){console.error("Error fetching data:",t),v({title:"Error",description:"Failed to load post data.",variant:"destructive"}),x("/creator/dashboard")}finally{U(!1)}})()},[u,i==null?void 0:i.id,l,v,x]);const X=()=>{j&&j.startsWith("blob:")&&URL.revokeObjectURL(j),A(null),F(null),P(null),M(null),$(null)},Z=async s=>{var t;if(!(!i||!u||!g)){O(!0);try{let n=g.media_urls||[];if(_){const m=new FormData;m.append("media",_);const o=await fetch("/api/upload/post-media",{method:"POST",body:m});if(!o.ok)throw new Error("Failed to upload media");n=[(await o.json()).filename]}let a=null;if(s.scheduledDate&&s.scheduledTime){const[m,o]=s.scheduledTime.split(":"),r=new Date(s.scheduledDate);r.setHours(parseInt(m),parseInt(o),0,0),a=r}const d={title:((t=s.caption)==null?void 0:t.substring(0,50))||g.title,content:s.caption||g.content,media_type:D||g.media_type,media_urls:n,tier:s.accessTier==="free"?"public":s.accessTier,scheduled_for:a,status:a?"scheduled":g.status};console.log("Updating post with data:",d);const c=await fetch(`/api/posts/${u}`,{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify(d)});if(!c.ok)throw new Error("Failed to update post");const p=await c.json();console.log("Post updated successfully:",p),v({title:"Post updated",description:"Your post has been updated successfully."}),x("/creator/dashboard")}catch(n){console.error("Error updating post:",n),v({title:"Error",description:"Failed to update post. Please try again.",variant:"destructive"})}finally{O(!1)}}},ee=s=>{var n;const t=(n=s.target.files)==null?void 0:n[0];if(t){A(t);const a=t.type.startsWith("image/")?"image":"video";P(a);const d=new FileReader;d.onload=c=>{var m;const p=(m=c.target)==null?void 0:m.result;if(F(p),a==="video"){const o=document.createElement("video");o.src=p,o.addEventListener("loadedmetadata",()=>{const r=o.videoWidth/o.videoHeight;$({width:o.videoWidth,height:o.videoHeight}),r>1?M("landscape"):M("portrait")})}},d.readAsDataURL(t)}};return J?e.jsx(H,{children:e.jsx("div",{className:"max-w-4xl mx-auto px-4 sm:px-6 lg:px-8 py-8",children:e.jsxs("div",{className:"text-center",children:[e.jsx("div",{className:"animate-spin rounded-full h-8 w-8 border-b-2 border-primary mx-auto"}),e.jsx("p",{className:"mt-4 text-muted-foreground",children:"Loading post..."})]})})}):e.jsx(H,{children:e.jsxs("div",{className:"max-w-4xl mx-auto px-4 sm:px-6 lg:px-8 py-8",children:[e.jsxs("div",{className:"mb-8",children:[e.jsxs(b,{variant:"outline",size:"sm",className:"mb-4 w-10 h-10 p-0 sm:w-auto sm:h-auto sm:p-2 sm:px-4",onClick:K,children:[e.jsx(Ne,{className:"w-4 h-4 sm:mr-2"}),e.jsx("span",{className:"hidden sm:inline",children:"Back to Dashboard"})]}),e.jsx("h1",{className:"text-2xl sm:text-3xl font-bold text-foreground mb-2",children:"Edit Post"}),e.jsx("p",{className:"text-sm sm:text-base text-muted-foreground",children:"Update your post content and settings"})]}),e.jsx(be,{...l,children:e.jsxs("form",{onSubmit:l.handleSubmit(Z),className:"space-y-6",children:[e.jsxs(I,{className:"bg-gradient-card border-border/50",children:[e.jsxs(E,{children:[e.jsx(L,{children:"Post Content"}),e.jsx(R,{children:"Update your caption and media"})]}),e.jsxs(V,{className:"space-y-6",children:[e.jsx(N,{control:l.control,name:"caption",render:({field:s})=>e.jsxs(y,{children:[e.jsx(C,{children:"Caption"}),e.jsx(S,{children:e.jsx(ne,{placeholder:"What's on your mind?",className:"min-h-[120px] resize-none",...s})}),e.jsx(T,{})]})}),e.jsxs("div",{className:"space-y-4",children:[e.jsx(W,{children:"Media (Optional)"}),j?e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"relative rounded-lg overflow-hidden bg-muted",children:[D==="image"?e.jsx("img",{src:j,alt:"Preview",className:"w-full h-64 object-cover"}):e.jsx("video",{src:j,className:"w-full h-64 object-cover",controls:!0}),e.jsx("div",{className:"absolute top-2 right-2",children:e.jsx(b,{type:"button",variant:"destructive",size:"sm",onClick:X,children:"Remove"})})]}),e.jsxs("div",{className:"flex items-center gap-2 text-sm text-muted-foreground",children:[D==="image"?e.jsx(ye,{className:"w-4 h-4"}):e.jsx(Ce,{className:"w-4 h-4"}),e.jsx("span",{children:"Media preview"})]})]}):e.jsxs("div",{className:"border-2 border-dashed border-border rounded-lg p-8 text-center",children:[e.jsx(z,{type:"file",accept:".jpg,.jpeg,.png,.gif,.mp4,.mov",onChange:ee,className:"hidden",id:"media-upload"}),e.jsx(W,{htmlFor:"media-upload",className:"cursor-pointer",children:e.jsxs("div",{className:"flex flex-col items-center gap-4",children:[e.jsx(ie,{className:"w-12 h-12 text-muted-foreground"}),e.jsxs("div",{children:[e.jsx("p",{className:"text-sm font-medium",children:"Click to upload new media"}),e.jsxs("p",{className:"text-xs text-muted-foreground",children:["Images: JPG, PNG, GIF (max 16MB)",e.jsx("br",{}),"Videos: MP4, MOV (max 16MB)"]})]})]})})]})]})]})]}),e.jsxs(I,{className:"bg-gradient-card border-border/50",children:[e.jsxs(E,{children:[e.jsx(L,{children:"Access Settings"}),e.jsx(R,{children:"Choose who can see this post"})]}),e.jsx(V,{className:"space-y-6",children:e.jsx(N,{control:l.control,name:"accessTier",render:({field:s})=>e.jsxs(y,{children:[e.jsx(C,{children:"Access Level"}),e.jsxs(ce,{onValueChange:s.onChange,value:s.value,children:[e.jsx(S,{children:e.jsx(me,{children:e.jsx(he,{placeholder:"Select access level"})})}),e.jsxs(ue,{children:[e.jsx(G,{value:"free",children:"Free for all followers"}),Y.map(t=>e.jsxs(G,{value:t.name,children:[t.name," (GHS ",t.price,"/month)"]},t.id))]})]}),e.jsx(T,{})]})})})]}),e.jsxs(I,{className:"bg-gradient-card border-border/50",children:[e.jsxs(E,{children:[e.jsx(L,{children:"Schedule Settings"}),e.jsx(R,{children:"Update when this post should be published"})]}),e.jsx(V,{children:e.jsxs("div",{className:"grid md:grid-cols-2 gap-4",children:[e.jsx(N,{control:l.control,name:"scheduledDate",render:({field:s})=>e.jsxs(y,{className:"flex flex-col",children:[e.jsx(C,{children:"Schedule Date (Optional)"}),e.jsxs(pe,{children:[e.jsx(xe,{asChild:!0,children:e.jsx(S,{children:e.jsxs(b,{variant:"outline",className:le("w-full pl-3 text-left font-normal",!s.value&&"text-muted-foreground"),children:[s.value?je(s.value,"PPP"):e.jsx("span",{children:"Pick a date"}),e.jsx(Se,{className:"ml-auto h-4 w-4 opacity-50"})]})})}),e.jsx(ge,{className:"w-auto p-0",align:"start",children:e.jsx(fe,{mode:"single",selected:s.value,onSelect:s.onChange,disabled:t=>t<new Date||t<new Date("1900-01-01"),initialFocus:!0})})]}),e.jsx(T,{})]})}),e.jsx(N,{control:l.control,name:"scheduledTime",render:({field:s})=>e.jsxs(y,{children:[e.jsx(C,{children:"Schedule Time"}),e.jsx(S,{children:e.jsxs("div",{className:"relative",children:[e.jsx(z,{type:"time",...s}),e.jsx(Te,{className:"absolute right-3 top-3 h-4 w-4 opacity-50"})]})}),e.jsx(T,{})]})})]})})]}),e.jsxs("div",{className:"flex flex-col sm:flex-row gap-4 justify-end",children:[e.jsx(b,{type:"button",variant:"outline",onClick:Q,disabled:k,children:"Cancel"}),e.jsx(b,{type:"submit",disabled:k,className:"bg-gradient-to-r from-primary to-primary/80 hover:from-primary/90 hover:to-primary/70",children:k?e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"animate-spin rounded-full h-4 w-4 border-b-2 border-white mr-2"}),"Saving..."]}):e.jsxs(e.Fragment,{children:[e.jsx(de,{className:"w-4 h-4 mr-2"}),"Save Changes"]})})]})]})})]})})};export{Be as EditPost};
