import{r as i,w as ge,a as pe,u as je,at as Ne,x as ye,j as e,I as b,M as f,A as v,m as w,n as S,l as ne,B as A,ad as be}from"./index-DnjzDop3.js";import{L as g}from"./loader-circle--UTD5YcZ.js";import{S as ie}from"./search-tyvWbnyU.js";import{S as ce}from"./send-Baqb8pKh.js";import{A as ve}from"./arrow-left-DJTbtmZM.js";const Pe=()=>{var D,O,Y,J,q,H,Q,W,G,U,V,X,Z,ee,se,te,ae,re;i.useRef(null),i.useRef(null);const k=i.useRef(null);ge();const{toast:p}=pe(),{user:c}=je(),{createConnection:P}=Ne(),[t,E]=i.useState(null),[le,oe]=i.useState([]),[j,C]=i.useState([]),[l,M]=i.useState(""),[N,L]=i.useState(""),[de,T]=i.useState(!1),[me,$]=i.useState(!0),[F,R]=i.useState(!1),[we,I]=i.useState(!1),[Se,xe]=i.useState(typeof Notification<"u"?Notification.permission:"default");i.useEffect(()=>{c&&ue(!0)},[c]),i.useEffect(()=>{t&&he(t.id)},[t]),i.useEffect(()=>{if(!(c!=null&&c.id))return;"Notification"in window&&xe(Notification.permission);const s=P(a=>{console.log("Received notification:",a)},a=>{if(console.log("Received real-time message:",a),a.type==="new_message_realtime"&&t&&a.conversationId===t.id){const r={...a.message,type:a.message.sender===(c.display_name||c.username)?"sent":"received"};C(n=>n.some(d=>d.id===r.id)?n:[...n,r])}});return k.current=s,()=>{k.current&&k.current.disconnect()}},[c==null?void 0:c.id,t,P]);const ue=async(s=!1)=>{try{s?$(!0):I(!0);const a=await fetch("/api/conversations",{credentials:"include"});if(a.ok){const r=await a.json();oe(r),r.length>0&&!t&&E(r[0])}else console.error("Failed to fetch conversations")}catch(a){console.error("Error fetching conversations:",a),p({title:"Error",description:"Failed to load conversations. Please try again.",variant:"destructive"})}finally{s?$(!1):I(!1)}},he=async s=>{try{R(!0);const a=await fetch(`/api/conversations/${s}/messages`,{credentials:"include"});if(a.ok){const r=await a.json();C(r)}else console.error("Failed to fetch messages")}catch(a){console.error("Error fetching messages:",a),p({title:"Error",description:"Failed to load messages. Please try again.",variant:"destructive"})}finally{R(!1)}},o=ye({mutationFn:async({conversationId:s,content:a})=>{const r=await fetch(`/api/conversations/${s}/messages`,{method:"POST",headers:{"Content-Type":"application/json"},credentials:"include",body:JSON.stringify({content:a})});if(!r.ok)throw new Error("Failed to send message");return r.json()},onSuccess:s=>{const a=l.trim();if(M(""),t&&c){const r={id:(s==null?void 0:s.id)||Date.now().toString(),content:(s==null?void 0:s.content)||a,sender:c.display_name||c.username,timestamp:(s==null?void 0:s.timestamp)||new Date().toISOString(),type:"sent"};C(n=>[...n,r])}p({title:"Message sent",description:"Your message has been sent successfully."})},onError:s=>{console.error("Error sending message:",s),p({title:"Error",description:"Failed to send message. Please try again.",variant:"destructive"})}}),y=le.filter(s=>{var r,n;const a=s.fan||s.creator;return a?((r=a.display_name)==null?void 0:r.toLowerCase().includes(N.toLowerCase()))||((n=a.username)==null?void 0:n.toLowerCase().includes(N.toLowerCase())):!1}),_=()=>{!l.trim()||!t||o.mutate({conversationId:t.id,content:l.trim()})},B=s=>{E(s),T(!0)},fe=()=>{T(!1)},K=s=>{const a=new Date(s),n=Math.floor((new Date().getTime()-a.getTime())/(1e3*60*60));return n<1?"Just now":n<24?`${n}h ago`:`${Math.floor(n/24)}d ago`},z=s=>{s.key==="Enter"&&!s.shiftKey&&(s.preventDefault(),_())};return me||!c?e.jsx("div",{className:"min-h-screen bg-background",children:e.jsx("div",{className:"flex items-center justify-center min-h-screen",children:e.jsxs("div",{className:"text-center",children:[e.jsx(g,{className:"h-8 w-8 animate-spin mx-auto mb-4 text-primary"}),e.jsx("p",{className:"text-muted-foreground",children:"Loading conversations..."})]})})}):e.jsxs("div",{className:"min-h-screen bg-background",children:[e.jsx("div",{className:"hidden lg:block",children:e.jsxs("div",{className:"max-w-7xl mx-auto px-4 py-6",children:[e.jsxs("div",{className:"mb-6 text-center sm:text-left",children:[e.jsx("h1",{className:"text-2xl sm:text-3xl font-bold text-foreground mb-2 flex items-center gap-2 justify-center sm:justify-start",children:"Messages"}),e.jsx("p",{className:"text-sm sm:text-base text-muted-foreground",children:"Connect with your subscribers"})]}),e.jsxs("div",{className:"grid grid-cols-1 lg:grid-cols-3 gap-6 h-[calc(100vh-200px)]",children:[e.jsxs("div",{className:"lg:col-span-1 bg-gradient-card border border-border/50 rounded-lg p-4 flex flex-col",children:[e.jsx("div",{className:"mb-4",children:e.jsxs("div",{className:"relative",children:[e.jsx(ie,{className:"absolute left-3 top-1/2 transform -translate-y-1/2 text-muted-foreground w-4 h-4"}),e.jsx(b,{placeholder:"Search conversations...",value:N,onChange:s=>L(s.target.value),className:"pl-10"})]})}),e.jsx("div",{className:"space-y-2 flex-1 overflow-y-auto",children:y.length===0?e.jsxs("div",{className:"text-center py-8 text-muted-foreground",children:[e.jsx(f,{className:"h-12 w-12 mx-auto mb-4 opacity-50"}),e.jsx("p",{children:"No conversations yet"}),e.jsx("p",{className:"text-sm mt-2",children:"Your subscribers will appear here when they message you!"})]}):y.map(s=>{var a,r,n,m,d,x,u,h;return e.jsx("div",{onClick:()=>B(s),className:`p-3 rounded-lg cursor-pointer transition-colors ${(t==null?void 0:t.id)===s.id?"bg-primary/20 border-primary":"hover:bg-muted/50"}`,children:e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsxs(v,{className:"w-12 h-12 flex-shrink-0",children:[e.jsx(w,{src:(a=s.fan||s.creator)==null?void 0:a.avatar,alt:(r=s.fan||s.creator)==null?void 0:r.display_name}),e.jsx(S,{children:((m=(n=s.fan||s.creator)==null?void 0:n.display_name)==null?void 0:m.charAt(0))||((x=(d=s.fan||s.creator)==null?void 0:d.username)==null?void 0:x.charAt(0))})]}),e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsxs("div",{className:"flex items-center justify-between gap-2",children:[e.jsx("p",{className:"font-medium text-foreground truncate",children:((u=s.fan||s.creator)==null?void 0:u.display_name)||((h=s.fan||s.creator)==null?void 0:h.username)}),e.jsx("span",{className:"text-xs text-muted-foreground flex-shrink-0",children:K(s.timestamp)})]}),e.jsx("p",{className:"text-sm text-muted-foreground truncate",children:s.last_message})]}),s.unread&&e.jsx(ne,{variant:"secondary",className:"ml-2",children:s.unread_count})]})},s.id)})})]}),e.jsx("div",{className:"lg:col-span-2 bg-gradient-card border border-border/50 rounded-lg flex flex-col",children:t?e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"p-4 border-b border-border/50 flex items-center gap-3",children:[e.jsxs(v,{className:"w-10 h-10",children:[e.jsx(w,{src:(D=t.fan||t.creator)==null?void 0:D.avatar,alt:(O=t.fan||t.creator)==null?void 0:O.display_name}),e.jsx(S,{children:((J=(Y=t.fan||t.creator)==null?void 0:Y.display_name)==null?void 0:J.charAt(0))||((H=(q=t.fan||t.creator)==null?void 0:q.username)==null?void 0:H.charAt(0))})]}),e.jsxs("div",{className:"flex-1",children:[e.jsx("h3",{className:"font-semibold text-foreground",children:((Q=t.fan||t.creator)==null?void 0:Q.display_name)||((W=t.fan||t.creator)==null?void 0:W.username)}),e.jsxs("p",{className:"text-sm text-muted-foreground",children:["@",(G=t.fan||t.creator)==null?void 0:G.username]})]})]}),e.jsx("div",{className:"flex-1 overflow-y-auto p-4 space-y-4",children:F?e.jsx("div",{className:"flex items-center justify-center py-8",children:e.jsx(g,{className:"h-6 w-6 animate-spin text-primary"})}):j.length===0?e.jsxs("div",{className:"text-center py-8 text-muted-foreground",children:[e.jsx(f,{className:"h-12 w-12 mx-auto mb-4 opacity-50"}),e.jsx("p",{children:"No messages yet"}),e.jsx("p",{className:"text-sm mt-2",children:"Start the conversation!"})]}):j.map(s=>e.jsx("div",{className:`flex ${s.type==="sent"?"justify-end":"justify-start"}`,children:e.jsxs("div",{className:`max-w-xs lg:max-w-md px-4 py-2 rounded-lg ${s.type==="sent"?"bg-primary text-primary-foreground":"bg-muted text-foreground"}`,children:[e.jsx("p",{className:"text-sm break-words",children:s.content}),e.jsx("p",{className:`text-xs mt-1 ${s.type==="sent"?"text-primary-foreground/70":"text-muted-foreground"}`,children:new Date(s.timestamp).toLocaleTimeString([],{hour:"2-digit",minute:"2-digit"})})]})},s.id))}),e.jsx("div",{className:"p-4 border-t border-border/50",children:e.jsxs("div",{className:"flex gap-2",children:[e.jsx(b,{placeholder:"Type your message...",value:l,onChange:s=>M(s.target.value),onKeyPress:z,className:"flex-1",disabled:o.isPending}),e.jsx(A,{onClick:_,disabled:!l.trim()||o.isPending,className:"px-4",children:o.isPending?e.jsx(g,{className:"h-4 w-4 animate-spin"}):e.jsx(ce,{className:"h-4 w-4"})})]})})]}):e.jsx("div",{className:"flex-1 flex items-center justify-center text-muted-foreground",children:e.jsxs("div",{className:"text-center",children:[e.jsx(f,{className:"h-16 w-16 mx-auto mb-4 opacity-50"}),e.jsx("p",{className:"text-lg",children:"Select a conversation to start messaging"})]})})})]})]})}),e.jsx("div",{className:"lg:hidden",children:de?e.jsxs("div",{className:"min-h-screen bg-background flex flex-col",children:[e.jsx("div",{className:"sticky top-0 z-10 bg-background border-b border-border/50 p-4",children:e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx(A,{variant:"ghost",size:"sm",onClick:fe,children:e.jsx(ve,{className:"w-4 h-4"})}),t&&e.jsxs(e.Fragment,{children:[e.jsxs(v,{className:"w-10 h-10",children:[e.jsx(w,{src:(U=t.fan||t.creator)==null?void 0:U.avatar,alt:(V=t.fan||t.creator)==null?void 0:V.display_name}),e.jsx(S,{children:((Z=(X=t.fan||t.creator)==null?void 0:X.display_name)==null?void 0:Z.charAt(0))||((se=(ee=t.fan||t.creator)==null?void 0:ee.username)==null?void 0:se.charAt(0))})]}),e.jsxs("div",{className:"flex-1",children:[e.jsx("h3",{className:"font-semibold text-foreground",children:((te=t.fan||t.creator)==null?void 0:te.display_name)||((ae=t.fan||t.creator)==null?void 0:ae.username)}),e.jsxs("p",{className:"text-sm text-muted-foreground",children:["@",(re=t.fan||t.creator)==null?void 0:re.username]})]})]})]})}),e.jsx("div",{className:"flex-1 overflow-y-auto p-4 space-y-4",children:F?e.jsx("div",{className:"flex items-center justify-center py-8",children:e.jsx(g,{className:"h-6 w-6 animate-spin text-primary"})}):j.length===0?e.jsxs("div",{className:"text-center py-8 text-muted-foreground",children:[e.jsx(f,{className:"h-12 w-12 mx-auto mb-4 opacity-50"}),e.jsx("p",{children:"No messages yet"}),e.jsx("p",{className:"text-sm mt-2",children:"Start the conversation!"})]}):j.map(s=>e.jsx("div",{className:`flex ${s.type==="sent"?"justify-end":"justify-start"}`,children:e.jsxs("div",{className:`max-w-xs px-4 py-2 rounded-lg ${s.type==="sent"?"bg-primary text-primary-foreground":"bg-muted text-foreground"}`,children:[e.jsx("p",{className:"text-sm break-words",children:s.content}),e.jsx("p",{className:`text-xs mt-1 ${s.type==="sent"?"text-primary-foreground/70":"text-muted-foreground"}`,children:new Date(s.timestamp).toLocaleTimeString([],{hour:"2-digit",minute:"2-digit"})})]})},s.id))}),e.jsx("div",{className:"sticky bottom-0 bg-background border-t border-border/50 p-4",children:e.jsxs("div",{className:"flex gap-2",children:[e.jsx(b,{placeholder:"Type your message...",value:l,onChange:s=>M(s.target.value),onKeyPress:z,className:"flex-1",disabled:o.isPending}),e.jsx(A,{onClick:_,disabled:!l.trim()||o.isPending,className:"px-4",children:o.isPending?e.jsx(g,{className:"h-4 w-4 animate-spin"}):e.jsx(ce,{className:"h-4 w-4"})})]})})]}):e.jsxs("div",{className:"min-h-screen bg-background",children:[e.jsxs("div",{className:"sticky top-0 z-10 bg-background border-b border-border/50 p-4",children:[e.jsx("div",{className:"flex items-center justify-between mb-4",children:e.jsx("div",{className:"flex items-center gap-3",children:e.jsx("h1",{className:"text-xl sm:text-2xl font-bold text-foreground",children:"Messages"})})}),e.jsxs("div",{className:"relative",children:[e.jsx(ie,{className:"absolute left-3 top-1/2 transform -translate-y-1/2 text-muted-foreground w-4 h-4"}),e.jsx(b,{placeholder:"Search conversations...",value:N,onChange:s=>L(s.target.value),className:"pl-10"})]})]}),e.jsx("div",{className:"p-4 space-y-2",children:y.length===0?e.jsxs("div",{className:"text-center py-16 text-muted-foreground",children:[e.jsx(f,{className:"h-16 w-16 mx-auto mb-4 opacity-50"}),e.jsx("p",{className:"text-lg",children:"No conversations yet"}),e.jsx("p",{className:"text-sm mt-2",children:"Your subscribers will appear here when they message you!"})]}):y.map(s=>{var a,r,n,m,d,x,u,h;return e.jsx("div",{onClick:()=>B(s),className:"p-4 bg-gradient-card border border-border/50 rounded-lg cursor-pointer hover:bg-muted/50 transition-colors",children:e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsxs(v,{className:"w-12 h-12 flex-shrink-0",children:[e.jsx(w,{src:(a=s.fan||s.creator)==null?void 0:a.avatar,alt:(r=s.fan||s.creator)==null?void 0:r.display_name}),e.jsx(S,{children:((m=(n=s.fan||s.creator)==null?void 0:n.display_name)==null?void 0:m.charAt(0))||((x=(d=s.fan||s.creator)==null?void 0:d.username)==null?void 0:x.charAt(0))})]}),e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsxs("div",{className:"flex items-center justify-between gap-2",children:[e.jsx("p",{className:"font-medium text-foreground truncate",children:((u=s.fan||s.creator)==null?void 0:u.display_name)||((h=s.fan||s.creator)==null?void 0:h.username)}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("span",{className:"text-xs text-muted-foreground flex-shrink-0",children:K(s.timestamp)}),e.jsx(be,{className:"w-4 h-4 text-muted-foreground"})]})]}),e.jsx("p",{className:"text-sm text-muted-foreground truncate",children:s.last_message})]}),s.unread&&e.jsx(ne,{variant:"secondary",className:"ml-2",children:s.unread_count})]})},s.id)})})]})})]})};export{Pe as Messages};
