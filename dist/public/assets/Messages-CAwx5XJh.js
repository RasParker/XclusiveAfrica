import{r as o,w as X,a as Z,u as ee,at as se,x as te,j as e,I as w,M as f,A as S,m as k,n as C,l as K,B as _,ad as re}from"./index-DnjzDop3.js";import{L as p}from"./loader-circle--UTD5YcZ.js";import{S as O}from"./search-tyvWbnyU.js";import{S as Y}from"./send-Baqb8pKh.js";import{A as ae}from"./arrow-left-DJTbtmZM.js";const J=i=>{if(!i)return"";try{const a=new Date,u=new Date(i),t=a.getTime()-u.getTime();if(t<0)return"Now";const d=Math.floor(t/(1e3*60)),j=Math.floor(t/(1e3*60*60)),g=Math.floor(t/(1e3*60*60*24)),c=Math.floor(g/7);return d<1?"Just now":d<60?`${d}m ago`:j<24?`${j}h ago`:g<7?`${g}d ago`:c<4?`${c}w ago`:u.toLocaleDateString("en-US",{month:"short",day:"numeric",year:u.getFullYear()!==a.getFullYear()?"numeric":void 0})}catch(a){return console.error("Error formatting date:",a),""}},me=()=>{var W,D;o.useState(typeof Notification<"u"?Notification.permission:"default"),X();const{toast:i}=Z(),{user:a}=ee(),{createConnection:u}=se(),[t,d]=o.useState(null),[j,g]=o.useState([]),[c,M]=o.useState([]),[l,E]=o.useState(""),[N,A]=o.useState(""),[q,I]=o.useState(!1),[H,P]=o.useState(!0),[L,T]=o.useState(!1),[ne,$]=o.useState(!1),y=o.useRef(null),v=o.useRef(null);o.useEffect(()=>{console.log("Messages component mounted"),a&&Q(!0)},[a]),o.useEffect(()=>{t&&U(t.id)},[t]),o.useEffect(()=>{y.current&&y.current.scrollIntoView({behavior:"smooth"})},[c]),o.useEffect(()=>{if(a!=null&&a.id){console.log("Initializing WebSocket connection for Messages");try{const s=u(r=>{console.log("Messages: Received notification:",r)},r=>{console.log("Messages: Received real-time message:",r),r.type==="new_message_realtime"&&M(n=>{const x=t==null?void 0:t.id;if(x&&r.conversationId===x){const h={...r.message,type:r.message.sender===a.username?"sent":"received"};if(!n.some(G=>G.id===h.id))return[...n,h]}return n})});v.current=s,console.log("WebSocket connection initialized for Messages")}catch(s){console.error("Failed to initialize WebSocket connection:",s)}return()=>{console.log("Cleaning up Messages WebSocket connection"),v.current&&(v.current.disconnect(),v.current=null)}}},[a==null?void 0:a.id,u]);const Q=async(s=!1)=>{try{console.log("Fetching conversations..."),s?P(!0):$(!0);const r=await fetch("/api/conversations",{credentials:"include"});if(r.ok){const n=await r.json();console.log("Fetched conversations:",n),g(n);const x=sessionStorage.getItem("autoSelectConversationId");if(x){const h=n.find(B=>B.id===x);h&&(console.log("Auto-selecting conversation:",h),d(h),sessionStorage.removeItem("autoSelectConversationId"))}else n.length>0&&!t&&d(n[0])}else{if(console.error("Failed to fetch conversations, status:",r.status),r.status===401){window.location.href="/";return}i({title:"Error",description:"Failed to load conversations. Please try again.",variant:"destructive"})}}catch(r){console.error("Error fetching conversations:",r),i({title:"Error",description:"Failed to load conversations. Please try again.",variant:"destructive"})}finally{s?P(!1):$(!1)}},U=async s=>{try{console.log("Fetching messages for conversation:",s),T(!0);const r=await fetch(`/api/conversations/${s}/messages`,{credentials:"include"});if(r.ok){const n=await r.json();console.log("Fetched messages:",n),M(n)}else console.error("Failed to fetch messages"),i({title:"Error",description:"Failed to load messages. Please try again.",variant:"destructive"})}catch(r){console.error("Error fetching messages:",r),i({title:"Error",description:"Failed to load messages. Please try again.",variant:"destructive"})}finally{T(!1)}},m=te({mutationFn:async({conversationId:s,content:r})=>{const n=await fetch(`/api/conversations/${s}/messages`,{method:"POST",headers:{"Content-Type":"application/json"},credentials:"include",body:JSON.stringify({content:r})});if(!n.ok)throw new Error("Failed to send message");return n.json()},onSuccess:async s=>{console.log("Message sent successfully:",s);const r=l.trim();if(t&&a){const n={id:(s==null?void 0:s.id)||Date.now().toString(),content:(s==null?void 0:s.content)||r,sender:a.username,timestamp:(s==null?void 0:s.timestamp)||new Date().toISOString(),type:"sent"};M(x=>[...x,n])}E(""),i({title:"Message sent",description:"Your message has been sent successfully."})},onError:s=>{console.error("Error sending message:",s),i({title:"Error",description:"Failed to send message. Please try again.",variant:"destructive"})}}),b=j.filter(s=>s.creator.display_name.toLowerCase().includes(N.toLowerCase())||s.creator.username.toLowerCase().includes(N.toLowerCase())),F=()=>{!l.trim()||!t||(console.log("Sending message:",l.trim()),m.mutate({conversationId:t.id,content:l.trim()}))},R=s=>{console.log("Selected conversation:",s),d(s),I(!0)},V=()=>{I(!1)},z=s=>{s.key==="Enter"&&!s.shiftKey&&(s.preventDefault(),F())};return H||!a?e.jsx("div",{className:"min-h-screen bg-background",children:e.jsx("div",{className:"flex items-center justify-center min-h-screen",children:e.jsxs("div",{className:"text-center",children:[e.jsx(p,{className:"h-8 w-8 animate-spin mx-auto mb-4 text-primary"}),e.jsx("p",{className:"text-muted-foreground",children:"Loading conversations..."})]})})}):e.jsxs("div",{className:"min-h-screen bg-background",children:[e.jsx("div",{className:"hidden lg:block",children:e.jsxs("div",{className:"max-w-7xl mx-auto px-4 py-6",children:[e.jsxs("div",{className:"mb-6 sm:mb-8",children:[e.jsx("h1",{className:"text-3xl font-bold text-foreground mb-2 flex items-center gap-2",children:"Messages"}),e.jsx("p",{className:"text-base text-muted-foreground",children:"Connect with your favorite creators"})]}),e.jsxs("div",{className:"grid grid-cols-1 lg:grid-cols-3 gap-6 h-[calc(100vh-200px)]",children:[e.jsxs("div",{className:"lg:col-span-1 bg-gradient-card border border-border/50 rounded-lg p-4 flex flex-col",children:[e.jsx("div",{className:"mb-4",children:e.jsxs("div",{className:"relative",children:[e.jsx(O,{className:"absolute left-3 top-1/2 transform -translate-y-1/2 text-muted-foreground w-4 h-4"}),e.jsx(w,{placeholder:"Search conversations...",value:N,onChange:s=>A(s.target.value),className:"pl-10"})]})}),e.jsx("div",{className:"space-y-2 flex-1 overflow-y-auto",children:b.length===0?e.jsxs("div",{className:"text-center py-8 text-muted-foreground",children:[e.jsx(f,{className:"h-12 w-12 mx-auto mb-4 opacity-50"}),e.jsx("p",{children:"No conversations yet"}),e.jsx("p",{className:"text-sm mt-2",children:"Start a conversation with a creator!"})]}):b.map(s=>{var r;return e.jsx("div",{onClick:()=>R(s),className:`p-3 rounded-lg cursor-pointer transition-colors ${(t==null?void 0:t.id)===s.id?"bg-primary/20 border-primary":"hover:bg-muted/50"}`,children:e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsxs(S,{className:"w-12 h-12 flex-shrink-0",children:[e.jsx(k,{src:s.creator.avatar,alt:s.creator.display_name}),e.jsx(C,{children:((r=s.creator.display_name)==null?void 0:r.charAt(0))||s.creator.username.charAt(0)})]}),e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsxs("div",{className:"flex items-center justify-between gap-2",children:[e.jsx("p",{className:"font-medium text-foreground truncate",children:s.creator.display_name||s.creator.username}),e.jsx("span",{className:"text-xs text-muted-foreground flex-shrink-0",children:J(s.timestamp)})]}),e.jsx("p",{className:"text-sm text-muted-foreground truncate",children:s.last_message})]}),s.unread&&e.jsx(K,{variant:"secondary",className:"ml-2",children:s.unread_count})]})},s.id)})})]}),e.jsx("div",{className:"lg:col-span-2 bg-gradient-card border border-border/50 rounded-lg flex flex-col",children:t?e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"p-4 border-b border-border/50 flex items-center gap-3",children:[e.jsxs(S,{className:"w-10 h-10",children:[e.jsx(k,{src:t.creator.avatar,alt:t.creator.display_name}),e.jsx(C,{children:((W=t.creator.display_name)==null?void 0:W.charAt(0))||t.creator.username.charAt(0)})]}),e.jsxs("div",{className:"flex-1",children:[e.jsx("h3",{className:"font-semibold text-foreground",children:t.creator.display_name||t.creator.username}),e.jsxs("p",{className:"text-sm text-muted-foreground",children:["@",t.creator.username]})]})]}),e.jsxs("div",{className:"flex-1 overflow-y-auto p-4 space-y-4",children:[L?e.jsx("div",{className:"flex items-center justify-center py-8",children:e.jsx(p,{className:"h-6 w-6 animate-spin text-primary"})}):c.length===0?e.jsxs("div",{className:"text-center py-8 text-muted-foreground",children:[e.jsx(f,{className:"h-12 w-12 mx-auto mb-4 opacity-50"}),e.jsx("p",{children:"No messages yet"}),e.jsx("p",{className:"text-sm mt-2",children:"Start the conversation!"})]}):c.map(s=>e.jsx("div",{className:`flex ${s.type==="sent"?"justify-end":"justify-start"}`,children:e.jsxs("div",{className:`max-w-xs lg:max-w-md px-4 py-2 rounded-lg ${s.type==="sent"?"bg-primary text-primary-foreground":"bg-muted text-foreground"}`,children:[e.jsx("p",{className:"text-sm break-words",children:s.content}),e.jsx("p",{className:`text-xs mt-1 ${s.type==="sent"?"text-primary-foreground/70":"text-muted-foreground"}`,children:new Date(s.timestamp).toLocaleTimeString([],{hour:"2-digit",minute:"2-digit"})})]})},s.id)),e.jsx("div",{ref:y})]}),e.jsx("div",{className:"p-4 border-t border-border/50",children:e.jsxs("div",{className:"flex gap-2",children:[e.jsx(w,{placeholder:"Type your message...",value:l,onChange:s=>E(s.target.value),onKeyPress:z,className:"flex-1",disabled:m.isPending}),e.jsx(_,{onClick:F,disabled:!l.trim()||m.isPending,className:"px-4",children:m.isPending?e.jsx(p,{className:"h-4 w-4 animate-spin"}):e.jsx(Y,{className:"h-4 w-4"})})]})})]}):e.jsx("div",{className:"flex-1 flex items-center justify-center text-muted-foreground",children:e.jsxs("div",{className:"text-center",children:[e.jsx(f,{className:"h-16 w-16 mx-auto mb-4 opacity-50"}),e.jsx("p",{className:"text-lg",children:"Select a conversation to start messaging"})]})})})]})]})}),e.jsx("div",{className:"lg:hidden",children:q?e.jsxs("div",{className:"min-h-screen bg-background flex flex-col",children:[e.jsx("div",{className:"sticky top-0 z-10 bg-background border-b border-border/50 p-4",children:e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx(_,{variant:"ghost",size:"sm",onClick:V,children:e.jsx(ae,{className:"w-4 h-4"})}),t&&e.jsxs(e.Fragment,{children:[e.jsxs(S,{className:"w-10 h-10",children:[e.jsx(k,{src:t.creator.avatar,alt:t.creator.display_name}),e.jsx(C,{children:((D=t.creator.display_name)==null?void 0:D.charAt(0))||t.creator.username.charAt(0)})]}),e.jsxs("div",{className:"flex-1",children:[e.jsx("h3",{className:"font-semibold text-foreground",children:t.creator.display_name||t.creator.username}),e.jsxs("p",{className:"text-sm text-muted-foreground",children:["@",t.creator.username]})]})]})]})}),e.jsxs("div",{className:"flex-1 overflow-y-auto p-4 space-y-4",children:[L?e.jsx("div",{className:"flex items-center justify-center py-8",children:e.jsx(p,{className:"h-6 w-6 animate-spin text-primary"})}):c.length===0?e.jsxs("div",{className:"text-center py-8 text-muted-foreground",children:[e.jsx(f,{className:"h-12 w-12 mx-auto mb-4 opacity-50"}),e.jsx("p",{children:"No messages yet"}),e.jsx("p",{className:"text-sm mt-2",children:"Start the conversation!"})]}):c.map(s=>e.jsx("div",{className:`flex ${s.type==="sent"?"justify-end":"justify-start"}`,children:e.jsxs("div",{className:`max-w-xs px-4 py-2 rounded-lg ${s.type==="sent"?"bg-primary text-primary-foreground":"bg-muted text-foreground"}`,children:[e.jsx("p",{className:"text-sm break-words",children:s.content}),e.jsx("p",{className:`text-xs mt-1 ${s.type==="sent"?"text-primary-foreground/70":"text-muted-foreground"}`,children:new Date(s.timestamp).toLocaleTimeString([],{hour:"2-digit",minute:"2-digit"})})]})},s.id)),e.jsx("div",{ref:y})]}),e.jsx("div",{className:"sticky bottom-0 bg-background border-t border-border/50 p-4",children:e.jsxs("div",{className:"flex gap-2",children:[e.jsx(w,{placeholder:"Type your message...",value:l,onChange:s=>E(s.target.value),onKeyPress:z,className:"flex-1",disabled:m.isPending}),e.jsx(_,{onClick:F,disabled:!l.trim()||m.isPending,className:"px-4",children:m.isPending?e.jsx(p,{className:"h-4 w-4 animate-spin"}):e.jsx(Y,{className:"h-4 w-4"})})]})})]}):e.jsxs("div",{className:"min-h-screen bg-background",children:[e.jsxs("div",{className:"sticky top-0 z-10 bg-background border-b border-border/50 p-4",children:[e.jsxs("div",{className:"mb-6 sm:mb-8 text-center sm:text-left",children:[e.jsx("h1",{className:"text-2xl sm:text-3xl font-bold text-foreground mb-2 flex items-center gap-2 justify-center sm:justify-start",children:"Messages"}),e.jsx("p",{className:"text-sm sm:text-base text-muted-foreground",children:"Chat with your favorite creators"})]}),e.jsxs("div",{className:"relative",children:[e.jsx(O,{className:"absolute left-3 top-1/2 transform -translate-y-1/2 text-muted-foreground w-4 h-4"}),e.jsx(w,{placeholder:"Search conversations...",value:N,onChange:s=>A(s.target.value),className:"pl-10"})]})]}),e.jsx("div",{className:"p-4 space-y-2",children:b.length===0?e.jsxs("div",{className:"text-center py-16 text-muted-foreground",children:[e.jsx(f,{className:"h-16 w-16 mx-auto mb-4 opacity-50"}),e.jsx("p",{className:"text-lg",children:"No conversations yet"}),e.jsx("p",{className:"text-sm mt-2",children:"Start a conversation with a creator!"})]}):b.map(s=>{var r;return e.jsx("div",{onClick:()=>R(s),className:"p-4 bg-gradient-card border border-border/50 rounded-lg cursor-pointer hover:bg-muted/50 transition-colors",children:e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsxs(S,{className:"w-12 h-12 flex-shrink-0",children:[e.jsx(k,{src:s.creator.avatar,alt:s.creator.display_name}),e.jsx(C,{children:((r=s.creator.display_name)==null?void 0:r.charAt(0))||s.creator.username.charAt(0)})]}),e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsxs("div",{className:"flex items-center justify-between gap-2",children:[e.jsx("p",{className:"font-medium text-foreground truncate",children:s.creator.display_name||s.creator.username}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("span",{className:"text-xs text-muted-foreground flex-shrink-0",children:J(s.timestamp)}),e.jsx(re,{className:"w-4 h-4 text-muted-foreground"})]})]}),e.jsx("p",{className:"text-sm text-muted-foreground truncate",children:s.last_message})]}),s.unread&&e.jsx(K,{variant:"secondary",className:"ml-2",children:s.unread_count})]})},s.id)})})]})})]})};export{me as Messages};
