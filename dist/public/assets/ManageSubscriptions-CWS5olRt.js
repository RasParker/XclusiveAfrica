import{i as M,u as ue,a as pe,r as f,j as e,D as I,p as z,q as O,s as G,E as Y,B as y,C as x,g as h,l as p,F as B,R as be,A as ne,m as le,n as de,h as ie,aa as ce,X as oe,z as _e,a2 as Se,ab as Ce,L as ke}from"./index-DnjzDop3.js";import{E as De}from"./EdgeToEdgeContainer-kS07pzFb.js";import{C as Pe,a as Ae,b as Te}from"./collapsible-B5WvucI8.js";import{T as Ne,a as ve,b as P,c as q}from"./tabs-Tn3DyEKi.js";import{S as me}from"./star-DUOoHea0.js";import{C as L}from"./clock-DLXk1hVQ.js";import{C as ye}from"./calendar-We5RV4OF.js";import{T as Ee}from"./triangle-alert-Dv17xG_Y.js";import{P as xe}from"./play-B34JkaPD.js";import{C as Fe}from"./chevron-up-CD9nw7va.js";import{L as J}from"./LoadingSpinner-D0nQGNMo.js";import{H as Me}from"./heart-BIzJO6uv.js";/**
 * @license lucide-react v0.453.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const V=M("ArrowDown",[["path",{d:"M12 5v14",key:"s699le"}],["path",{d:"m19 12-7 7-7-7",key:"1idqje"}]]);/**
 * @license lucide-react v0.453.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const he=M("ArrowUpDown",[["path",{d:"m21 16-4 4-4-4",key:"f6ql7i"}],["path",{d:"M17 20V4",key:"1ejh1v"}],["path",{d:"m3 8 4-4 4 4",key:"11wl7u"}],["path",{d:"M7 4v16",key:"1glfcx"}]]);/**
 * @license lucide-react v0.453.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const W=M("ArrowUp",[["path",{d:"m5 12 7-7 7 7",key:"hav0vg"}],["path",{d:"M12 19V5",key:"x0mq9r"}]]);/**
 * @license lucide-react v0.453.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const ge=M("History",[["path",{d:"M3 12a9 9 0 1 0 9-9 9.75 9.75 0 0 0-6.74 2.74L3 8",key:"1357e3"}],["path",{d:"M3 3v5h5",key:"1xhq8a"}],["path",{d:"M12 7v5l4 2",key:"1fdv2h"}]]);/**
 * @license lucide-react v0.453.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const je=M("Pause",[["rect",{x:"14",y:"4",width:"4",height:"16",rx:"1",key:"zuxfzm"}],["rect",{x:"6",y:"4",width:"4",height:"16",rx:"1",key:"1okwgv"}]]),He=({isOpen:a,onClose:N,subscription:s,onSubscriptionUpdate:u})=>{var R,X,K,Q,Z,ee,ae,se;const{user:i}=ue(),{toast:m}=pe(),[c,w]=f.useState(!1),[g,o]=f.useState(null),[C,A]=f.useState([]),[T,E]=f.useState([]),[H,k]=f.useState([]),[b,S]=f.useState(null),r=async()=>{if(!(i!=null&&i.id)||!(s!=null&&s.id)){console.log("Missing user ID or subscription ID:",{userId:i==null?void 0:i.id,subscriptionId:s==null?void 0:s.id}),w(!1);return}b&&b.abort();const t=new AbortController;S(t);try{w(!0),console.log("Fetching tier data for subscription:",s.id);const l=await fetch(`/api/subscriptions/user/${i.id}`,{signal:t.signal});if(console.log("API Response status:",l.status),l.ok){const n=await l.json();if(console.log("API Response data:",n),n.success&&n.data&&Array.isArray(n.data)){const j=n.data.find(D=>D.id===s.id);if(console.log("Found enhanced subscription:",j),j){const D=Array.isArray(j.available_tiers)?j.available_tiers:[],te=Array.isArray(j.pending_changes)?j.pending_changes:[],re=Array.isArray(j.change_history)?j.change_history:[];console.log("Setting tier data:",{tierOptions:D,pendingChanges:te,changeHistory:re}),A(D),E(te),k(re)}else console.warn("Enhanced subscription not found for ID:",s.id),m({title:"Warning",description:"Could not load tier management data. Some features may be limited.",variant:"destructive"})}else throw console.error("Invalid API response structure:",n),new Error("Invalid response format")}else throw console.error("API request failed:",l.status,l.statusText),new Error(`API request failed: ${l.status}`)}catch(l){l.name!=="AbortError"&&(console.error("Error fetching tier data:",l),m({title:"Error",description:"Failed to load tier management data. Please try again.",variant:"destructive"}))}finally{w(!1),S(null)}};if(f.useEffect(()=>{a&&s?r():a||(A([]),E([]),k([]),w(!1),o(null),b&&(b.abort(),S(null)))},[a,s==null?void 0:s.id]),!a)return null;const d=s&&s.creator&&s.tier&&(s.creator.username||s.creator.display_name)&&s.tier.name&&s.tier.price;if(console.log("Modal validation check:",{isValidSubscription:d,subscription:s}),!d)return console.error("Invalid subscription data in modal:",s),e.jsx(I,{open:a,onOpenChange:N,children:e.jsxs(z,{className:"sm:max-w-md",children:[e.jsxs(O,{children:[e.jsx(G,{children:"Error Loading Subscription"}),e.jsx(Y,{children:"There was an issue loading the subscription data"})]}),e.jsxs("div",{className:"p-4 text-center",children:[e.jsx("p",{className:"text-muted-foreground mb-4",children:"Unable to load subscription details. The subscription data appears to be incomplete."}),e.jsxs("div",{className:"text-xs text-left mb-4 p-2 bg-muted/50 rounded",children:[e.jsx("p",{children:"Debug info:"}),e.jsxs("p",{children:["Has subscription: ",s?"Yes":"No"]}),e.jsxs("p",{children:["Has creator: ",s!=null&&s.creator?"Yes":"No"]}),e.jsxs("p",{children:["Has tier: ",s!=null&&s.tier?"Yes":"No"]}),e.jsxs("p",{children:["Creator username: ",((R=s==null?void 0:s.creator)==null?void 0:R.username)||"Missing"]}),e.jsxs("p",{children:["Creator display_name: ",((X=s==null?void 0:s.creator)==null?void 0:X.display_name)||"Missing"]}),e.jsxs("p",{children:["Tier name: ",((K=s==null?void 0:s.tier)==null?void 0:K.name)||"Missing"]}),e.jsxs("p",{children:["Tier price: ",((Q=s==null?void 0:s.tier)==null?void 0:Q.price)||"Missing"]})]}),e.jsx(y,{onClick:N,children:"Close"})]})]})});const v=async t=>{o(t);try{const n=await(await fetch(`/api/subscriptions/${s.id}/upgrade`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({tier_id:t})})).json();if(n.success&&n.requires_payment){const j=C.find(D=>D.id===t);m({title:"Payment Required",description:`Upgrade requires payment of GHS ${n.data.proration_amount.toFixed(2)} for the remaining ${n.data.days_remaining} days.`}),_(t,n.data.proration_amount)}else if(n.success)m({title:"Tier Upgraded!",description:"Your subscription tier has been upgraded successfully.",variant:"default"}),u(),N();else throw new Error(n.message||"Upgrade failed")}catch(l){m({title:"Upgrade Failed",description:l.message||"Failed to upgrade subscription tier",variant:"destructive"})}finally{o(null)}},_=async(t,l)=>{try{const j=await(await fetch("/api/payments/initialize",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({fan_id:i==null?void 0:i.id,tier_id:t,payment_method:"card",subscription_type:"tier_upgrade",existing_subscription_id:s.id,proration_amount:l})})).json();if(j.success&&j.data.authorization_url)window.location.href=j.data.authorization_url;else throw new Error(j.message||"Payment initialization failed")}catch(n){m({title:"Payment Error",description:n.message||"Failed to initialize payment",variant:"destructive"})}},F=async t=>{o(t);try{const n=await(await fetch(`/api/subscriptions/${s.id}/schedule-downgrade`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({tier_id:t})})).json();if(n.success)m({title:"Downgrade Scheduled",description:`Your tier will be downgraded on ${new Date(n.data.scheduled_date).toLocaleDateString()}. You'll keep current access until then.`,variant:"default"}),r();else throw new Error(n.message||"Downgrade scheduling failed")}catch(l){m({title:"Downgrade Failed",description:l.message||"Failed to schedule downgrade",variant:"destructive"})}finally{o(null)}},we=async t=>{try{if((await fetch(`/api/subscriptions/pending-changes/${t}`,{method:"DELETE"})).ok)m({title:"Change Cancelled",description:"Scheduled tier change has been cancelled",variant:"default"}),r();else throw new Error("Failed to cancel change")}catch(l){m({title:"Cancellation Failed",description:l.message||"Failed to cancel scheduled change",variant:"destructive"})}},U=C.filter(t=>t.is_upgrade),$=C.filter(t=>!t.is_upgrade);return c?(console.log("Modal showing loading state"),e.jsx(I,{open:a,onOpenChange:N,children:e.jsxs(z,{className:"sm:max-w-md",children:[e.jsxs(O,{children:[e.jsx(G,{children:"Loading Tier Management"}),e.jsx(Y,{children:"Fetching your subscription tier options..."})]}),e.jsx("div",{className:"flex items-center justify-center p-8",children:e.jsx("div",{className:"animate-spin rounded-full h-8 w-8 border-b-2 border-primary"})})]})})):e.jsx(I,{open:a,onOpenChange:N,children:e.jsxs(z,{className:"sm:max-w-4xl max-h-[90vh] overflow-y-auto",children:[e.jsxs(O,{children:[e.jsxs(G,{className:"text-left",children:["Manage Subscription - ",((Z=s==null?void 0:s.creator)==null?void 0:Z.display_name)||((ee=s==null?void 0:s.creator)==null?void 0:ee.username)||"Creator"]}),e.jsx(Y,{children:"Manage your subscription tier and view billing history"})]}),e.jsxs("div",{className:"space-y-6",children:[e.jsx(x,{className:"bg-gradient-to-r from-blue-50 to-indigo-50 dark:from-blue-950/20 dark:to-indigo-950/20 border-blue-200 dark:border-blue-800",children:e.jsx(h,{className:"p-4",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(me,{className:"h-5 w-5 text-yellow-500 fill-current"}),e.jsx("span",{className:"font-semibold",children:"Current Tier:"})]}),e.jsx(p,{variant:"secondary",className:"text-sm",children:((ae=s==null?void 0:s.tier)==null?void 0:ae.name)||"Unknown Tier"}),e.jsxs("span",{className:"text-lg font-bold",children:["GHS ",((se=s==null?void 0:s.tier)==null?void 0:se.price)||"0","/month"]})]}),e.jsxs("div",{className:"text-right text-sm text-muted-foreground",children:[e.jsxs("div",{children:["Next billing: ",s!=null&&s.next_billing_date?new Date(s.next_billing_date).toLocaleDateString():"N/A"]}),e.jsxs("div",{className:"text-xs",children:["Status: ",(s==null?void 0:s.status)||"Unknown"]})]})]})})}),T.length>0&&e.jsx(x,{className:"border-orange-200 bg-orange-50 dark:border-orange-800 dark:bg-orange-950/20",children:e.jsx(h,{className:"p-4",children:e.jsxs("div",{className:"flex items-start gap-3",children:[e.jsx(L,{className:"h-5 w-5 text-orange-500 mt-0.5"}),e.jsxs("div",{className:"flex-1",children:[e.jsx("h4",{className:"font-semibold text-orange-800 dark:text-orange-200",children:"Pending Changes"}),T.map(t=>{var l,n;return e.jsx("div",{className:"mt-2 p-3 bg-white dark:bg-gray-800 rounded-md border",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsxs("span",{className:"font-medium",children:[t.change_type==="downgrade"?"Downgrade":"Change"," to ",((l=t==null?void 0:t.to_tier)==null?void 0:l.name)||"Unknown Tier"]}),e.jsxs("div",{className:"text-sm text-muted-foreground",children:["Effective: ",t!=null&&t.scheduled_date?new Date(t.scheduled_date).toLocaleDateString():"N/A"]})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsxs(p,{variant:"outline",children:["GHS ",((n=t==null?void 0:t.to_tier)==null?void 0:n.price)||"0","/month"]}),e.jsx(y,{size:"sm",variant:"outline",onClick:()=>we(t.id),children:"Cancel"})]})]})},t.id)})]})]})})}),e.jsxs(Ne,{defaultValue:"upgrade",className:"w-full",children:[e.jsxs(ve,{className:"grid w-full grid-cols-3",children:[e.jsxs(P,{value:"upgrade",className:"flex items-center gap-2",children:[e.jsx(W,{className:"h-4 w-4"}),"Upgrade (",U.length,")"]}),e.jsxs(P,{value:"downgrade",className:"flex items-center gap-2",children:[e.jsx(V,{className:"h-4 w-4"}),"Downgrade (",$.length,")"]}),e.jsxs(P,{value:"history",className:"flex items-center gap-2",children:[e.jsx(ge,{className:"h-4 w-4"}),"History"]})]}),e.jsx(q,{value:"upgrade",className:"space-y-4",children:!c&&U.length===0?e.jsx(x,{children:e.jsxs(h,{className:"p-6 text-center",children:[e.jsx(me,{className:"h-12 w-12 mx-auto text-muted-foreground mb-3"}),e.jsx("p",{className:"text-muted-foreground",children:"You're already on the highest tier! 🎉"})]})}):c?e.jsx(x,{children:e.jsxs(h,{className:"p-6 text-center",children:[e.jsx("div",{className:"animate-spin rounded-full h-8 w-8 border-b-2 border-primary mx-auto mb-3"}),e.jsx("p",{className:"text-muted-foreground",children:"Loading upgrade options..."})]})}):U.map(t=>e.jsx(x,{className:"border-green-200 hover:border-green-300 transition-colors",children:e.jsx(h,{className:"p-4",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx(W,{className:"h-5 w-5 text-green-600"}),e.jsx("h3",{className:"text-lg font-semibold",children:t.name}),e.jsxs(p,{className:"bg-green-100 text-green-800 border-green-200",children:["GHS ",t.price,"/month"]})]}),e.jsx("p",{className:"text-sm text-muted-foreground",children:t.description}),e.jsxs("div",{className:"flex items-center gap-4 text-sm",children:[e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx(B,{className:"h-4 w-4"}),e.jsxs("span",{children:["Pay now: GHS ",t.proration_amount.toFixed(2),"(",t.days_remaining," days remaining)"]})]}),e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx(ye,{className:"h-4 w-4"}),e.jsx("span",{children:"Immediate access"})]})]})]}),e.jsx(y,{onClick:()=>v(t.id),disabled:c||g===t.id,className:"bg-green-600 hover:bg-green-700 text-white","data-testid":`button-upgrade-tier-${t.id}`,children:g===t.id?"Processing...":"Upgrade Now"})]})})},t.id))}),e.jsx(q,{value:"downgrade",className:"space-y-4",children:!c&&$.length===0?e.jsx(x,{children:e.jsxs(h,{className:"p-6 text-center",children:[e.jsx(Ee,{className:"h-12 w-12 mx-auto text-muted-foreground mb-3"}),e.jsx("p",{className:"text-muted-foreground",children:"No lower tiers available"})]})}):c?e.jsx(x,{children:e.jsxs(h,{className:"p-6 text-center",children:[e.jsx("div",{className:"animate-spin rounded-full h-8 w-8 border-b-2 border-primary mx-auto mb-3"}),e.jsx("p",{className:"text-muted-foreground",children:"Loading downgrade options..."})]})}):$.map(t=>e.jsx(x,{className:"border-orange-200 hover:border-orange-300 transition-colors",children:e.jsx(h,{className:"p-4",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx(V,{className:"h-5 w-5 text-orange-600"}),e.jsx("h3",{className:"text-lg font-semibold",children:t.name}),e.jsxs(p,{variant:"outline",className:"border-orange-200",children:["GHS ",t.price,"/month"]})]}),e.jsx("p",{className:"text-sm text-muted-foreground",children:t.description}),e.jsxs("div",{className:"flex items-center gap-4 text-sm",children:[e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx(L,{className:"h-4 w-4"}),e.jsx("span",{children:"Takes effect next billing cycle"})]}),e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx(B,{className:"h-4 w-4"}),e.jsxs("span",{children:["GHS ",Math.abs(t.proration_amount).toFixed(2)," credit applied"]})]})]})]}),e.jsx(y,{onClick:()=>F(t.id),disabled:c||g===t.id,variant:"outline",className:"border-orange-300 text-orange-700 hover:bg-orange-50","data-testid":`button-downgrade-tier-${t.id}`,children:g===t.id?"Processing...":"Schedule Downgrade"})]})})},t.id))}),e.jsx(q,{value:"history",className:"space-y-4",children:!c&&H.length===0?e.jsx(x,{children:e.jsxs(h,{className:"p-6 text-center",children:[e.jsx(ge,{className:"h-12 w-12 mx-auto text-muted-foreground mb-3"}),e.jsx("p",{className:"text-muted-foreground",children:"No tier changes yet"})]})}):c?e.jsx(x,{children:e.jsxs(h,{className:"p-6 text-center",children:[e.jsx("div",{className:"animate-spin rounded-full h-8 w-8 border-b-2 border-primary mx-auto mb-3"}),e.jsx("p",{className:"text-muted-foreground",children:"Loading history..."})]})}):e.jsx("div",{className:"space-y-3",children:H.map(t=>e.jsx(x,{children:e.jsx(h,{className:"p-4",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"space-y-1",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[t.change_type==="upgrade"?e.jsx(W,{className:"h-4 w-4 text-green-600"}):e.jsx(V,{className:"h-4 w-4 text-orange-600"}),e.jsxs("span",{className:"font-medium",children:[t.from_tier?`${t.from_tier.name} → `:"",t.to_tier.name]}),e.jsx(p,{variant:"outline",className:"text-xs",children:t.change_type})]}),e.jsxs("div",{className:"text-sm text-muted-foreground",children:[new Date(t.effective_date).toLocaleDateString(),t.proration_amount!=="0.00"&&e.jsxs("span",{className:"ml-3",children:["Amount: GHS ",t.proration_amount]})]})]}),e.jsx(p,{variant:"secondary",children:t.billing_impact})]})})},t.id))})})]})]})]})})},fe=({subscription:a,onPauseResume:N,onCancel:s,onToggleAutoRenew:u,onSubscriptionUpdate:i})=>{const[m,c]=f.useState(!1),[w,g]=f.useState(!1);return be.useEffect(()=>{console.log("SubscriptionCard mounted with subscription:",a)},[a]),e.jsxs(x,{className:"bg-gradient-card border-border/50",children:[e.jsxs(h,{className:"p-0",children:[e.jsxs("div",{className:"hidden sm:block p-6",children:[e.jsxs("div",{className:"flex flex-row items-start justify-between gap-4",children:[e.jsxs("div",{className:"flex items-center gap-4 min-w-0 flex-1",children:[e.jsxs(ne,{className:"h-16 w-16 flex-shrink-0",children:[e.jsx(le,{src:a.creator.avatar,alt:a.creator.username}),e.jsx(de,{children:a.creator.display_name.charAt(0)})]}),e.jsxs("div",{className:"min-w-0 flex-1",children:[e.jsx("h3",{className:"text-lg font-semibold text-foreground truncate",children:a.creator.display_name}),e.jsxs("p",{className:"text-sm text-muted-foreground truncate",children:["@",a.creator.username]}),e.jsxs("div",{className:"flex flex-wrap items-center gap-2 mt-2",children:[e.jsx(p,{variant:"outline",className:"text-xs",children:a.tier.name}),e.jsx(p,{variant:a.status==="active"?"success":a.status==="paused"?"destructive":"secondary",className:"text-xs",children:a.status}),a.pending_changes&&a.pending_changes.length>0&&e.jsxs(p,{variant:"outline",className:"text-xs bg-orange-50 text-orange-700 border-orange-200",children:[e.jsx(L,{className:"h-3 w-3 mr-1"}),"Pending change"]})]})]})]}),e.jsxs("div",{className:"flex flex-col text-right gap-2",children:[e.jsxs("p",{className:"text-lg font-bold text-foreground",children:["GHS ",a.tier.price,"/month"]}),e.jsxs("p",{className:"text-sm text-muted-foreground",children:["Next: ",a.next_billing_date?new Date(a.next_billing_date).toLocaleDateString():"N/A"]}),e.jsxs("p",{className:"text-xs text-muted-foreground",children:["Joined: ",new Date(a.created_at).toLocaleDateString()]})]})]}),e.jsxs("div",{className:"flex flex-row items-center justify-between gap-3 mt-4 pt-4 border-t border-border/50",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(ie,{htmlFor:`auto-renew-${a.id}`,className:"text-sm text-muted-foreground",children:"Auto-renew"}),e.jsx(ce,{id:`auto-renew-${a.id}`,checked:a.auto_renew,onCheckedChange:o=>u==null?void 0:u(a.id,o),disabled:a.status!=="active"})]}),e.jsxs("div",{className:"flex gap-2",children:[e.jsxs(y,{variant:"outline",size:"sm",onClick:()=>{console.log("Desktop Manage Tier button clicked, subscription data:",a),a&&a.creator&&a.tier?(console.log("Opening tier management modal"),g(!0)):(console.error("Incomplete subscription data:",a),alert("Unable to load tier management. Please refresh the page and try again."))},"data-testid":`button-manage-tier-${a.id}`,children:[e.jsx(he,{className:"w-4 h-4 mr-1"}),"Manage Tier"]}),e.jsx(y,{variant:"outline",size:"sm",onClick:()=>N(a.id),children:a.status==="active"?e.jsxs(e.Fragment,{children:[e.jsx(je,{className:"w-4 h-4 mr-1"}),"Pause"]}):e.jsxs(e.Fragment,{children:[e.jsx(xe,{className:"w-4 h-4 mr-1"}),"Resume"]})}),e.jsxs(y,{variant:"outline",size:"sm",onClick:()=>s(a.id),children:[e.jsx(oe,{className:"w-4 h-4 mr-1"}),"Cancel"]})]})]})]}),e.jsxs(Pe,{open:m,onOpenChange:c,className:"sm:hidden",children:[e.jsx(Ae,{asChild:!0,children:e.jsx("div",{className:"p-4 cursor-pointer hover:bg-accent/5 transition-colors",children:e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsxs(ne,{className:"h-12 w-12 flex-shrink-0",children:[e.jsx(le,{src:a.creator.avatar,alt:a.creator.username}),e.jsx(de,{children:a.creator.display_name.charAt(0)})]}),e.jsxs("div",{className:"min-w-0 flex-1",children:[e.jsxs("div",{className:"flex items-center justify-between gap-2",children:[e.jsx("h3",{className:"text-base font-semibold text-foreground truncate",children:a.creator.display_name}),e.jsxs("div",{className:"flex items-center gap-1 flex-shrink-0",children:[e.jsx(p,{variant:a.status==="active"?"default":"destructive",className:"text-xs",children:a.status}),m?e.jsx(Fe,{className:"w-4 h-4 text-muted-foreground"}):e.jsx(_e,{className:"w-4 h-4 text-muted-foreground"})]})]}),e.jsxs("div",{className:"flex items-center justify-between gap-2 mt-1",children:[e.jsxs("p",{className:"text-sm text-muted-foreground truncate",children:["@",a.creator.username]}),e.jsxs("p",{className:"text-sm font-semibold text-foreground flex-shrink-0",children:["GHS ",a.tier.price,"/mo"]})]}),e.jsxs("div",{className:"flex items-center gap-2 mt-2",children:[e.jsx(p,{variant:"outline",className:"text-xs",children:a.tier.name}),a.pending_changes&&a.pending_changes.length>0&&e.jsxs(p,{variant:"outline",className:"text-xs bg-orange-50 text-orange-700 border-orange-200",children:[e.jsx(L,{className:"h-3 w-3 mr-1"}),"Pending"]})]})]})]})})}),e.jsx(Te,{children:e.jsxs("div",{className:"px-4 pb-4 space-y-4",children:[e.jsxs("div",{className:"bg-muted/30 rounded-lg p-3 space-y-2",children:[e.jsxs("div",{className:"flex justify-between items-center",children:[e.jsx("span",{className:"text-sm text-muted-foreground",children:"Next billing"}),e.jsx("span",{className:"text-sm font-medium",children:a.next_billing_date?new Date(a.next_billing_date).toLocaleDateString():"N/A"})]}),e.jsxs("div",{className:"flex justify-between items-center",children:[e.jsx("span",{className:"text-sm text-muted-foreground",children:"Joined"}),e.jsx("span",{className:"text-sm font-medium",children:new Date(a.created_at).toLocaleDateString()})]}),e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx(ie,{htmlFor:`auto-renew-${a.id}`,className:"text-xs sm:text-sm text-muted-foreground",children:"Auto-renew"}),e.jsx(ce,{id:`auto-renew-${a.id}`,checked:a.auto_renew,onCheckedChange:o=>u==null?void 0:u(a.id,o),disabled:a.status!=="active"})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsxs(y,{variant:"outline",size:"sm",className:"w-full",onClick:o=>{o.stopPropagation(),console.log("Mobile Manage Tier button clicked, subscription data:",a),a&&a.creator&&a.tier?(console.log("Opening tier management modal (mobile)"),g(!0)):(console.error("Incomplete subscription data:",a),alert("Unable to load tier management. Please refresh the page and try again."))},"data-testid":`button-manage-tier-mobile-${a.id}`,children:[e.jsx(he,{className:"w-4 h-4 mr-1"}),"Manage Tier"]}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx(y,{variant:"outline",size:"sm",onClick:o=>{o.stopPropagation(),N(a.id)},className:"flex-1",children:a.status==="active"?e.jsxs(e.Fragment,{children:[e.jsx(je,{className:"w-4 h-4 mr-1"}),"Pause"]}):e.jsxs(e.Fragment,{children:[e.jsx(xe,{className:"w-4 h-4 mr-1"}),"Resume"]})}),e.jsxs(y,{variant:"outline",size:"sm",className:"flex-1",onClick:o=>{o.stopPropagation(),s(a.id)},children:[e.jsx(oe,{className:"w-4 h-4 mr-1"}),"Cancel"]})]})]})]})})]})]}),w&&a&&e.jsx(He,{isOpen:w,onClose:()=>{console.log("Closing tier management modal"),g(!1)},subscription:a,onSubscriptionUpdate:()=>{i==null||i(),g(!1)}})]})},Be=()=>{const{toast:a}=pe(),{user:N}=ue();Se();const[s,u]=f.useState([]),[i,m]=f.useState(!0),[c,w]=f.useState(null),[g,o]=f.useState("active");f.useEffect(()=>{C()},[N]);const C=async()=>{if(N)try{m(!0),w(null);const r=await fetch(`/api/subscriptions/user/${N.id}`);if(!r.ok)throw new Error("Failed to fetch subscriptions");const d=await r.json();if(d.success)u(d.data);else throw new Error(d.message||"Failed to fetch subscriptions")}catch(r){w(r instanceof Error?r.message:"An error occurred"),console.error("Error fetching subscriptions:",r)}finally{m(!1)}},A=async r=>{const d=s.find(_=>_.id===r),v=(d==null?void 0:d.status)==="active"?"paused":"active";try{if(!(await fetch(`/api/subscriptions/${r}`,{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify({status:v,auto_renew:v==="active"})})).ok)throw new Error("Failed to update subscription");u(s.map(F=>F.id===r?{...F,status:v,auto_renew:v==="active"}:F)),a({title:v==="paused"?"Subscription paused":"Subscription resumed",description:v==="paused"?"Your subscription has been paused and will not renew.":"Your subscription has been resumed."})}catch{a({title:"Error",description:"Failed to update subscription. Please try again.",variant:"destructive"})}},T=async r=>{try{if(!(await fetch(`/api/subscriptions/${r}/cancel`,{method:"PUT",headers:{"Content-Type":"application/json"}})).ok)throw new Error("Failed to cancel subscription");u(s.filter(v=>v.id!==r)),a({title:"Subscription cancelled",description:"Your subscription has been cancelled successfully.",variant:"destructive"})}catch{a({title:"Error",description:"Failed to cancel subscription. Please try again.",variant:"destructive"})}},E=async(r,d)=>{try{if(!(await fetch(`/api/subscriptions/${r}`,{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify({auto_renew:d})})).ok)throw new Error("Failed to update auto-renew setting");u(s.map(_=>_.id===r?{..._,auto_renew:d}:_)),a({title:d?"Auto-renew enabled":"Auto-renew disabled",description:d?"Your subscription will automatically renew.":"Your subscription will not automatically renew."})}catch{a({title:"Error",description:"Failed to update auto-renew setting. Please try again.",variant:"destructive"})}},H=s.filter(r=>r.status==="active").reduce((r,d)=>r+parseFloat(d.tier.price),0),k=s.filter(r=>r.status==="active"),b=s.filter(r=>r.status==="paused"),S=s.filter(r=>!["active","paused"].includes(r.status));return e.jsx(Ce,{children:e.jsxs(De,{maxWidth:"7xl",enablePadding:!0,enableTopPadding:!0,children:[e.jsxs("div",{className:"mb-6 sm:mb-8 text-center sm:text-left",children:[e.jsx("h1",{className:"text-2xl sm:text-3xl font-bold text-foreground mb-2 flex items-center gap-2 justify-center sm:justify-start",children:"Manage Subscriptions"}),e.jsx("p",{className:"text-sm sm:text-base text-muted-foreground",children:"View and manage all your creator subscriptions"})]}),e.jsxs("div",{className:"grid grid-cols-1 sm:grid-cols-3 gap-3 sm:gap-4 mb-6 sm:mb-8",children:[e.jsx(x,{className:"bg-gradient-card border-border/50",children:e.jsx(h,{className:"p-4 sm:p-6",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsx("p",{className:"text-xs sm:text-sm font-medium text-muted-foreground",children:"Active Subscriptions"}),e.jsx("p",{className:"text-xl sm:text-2xl font-bold text-foreground",children:s.filter(r=>r.status==="active").length})]}),e.jsx(Me,{className:"h-6 w-6 sm:h-8 sm:w-8 text-white",strokeWidth:1})]})})}),e.jsx(x,{className:"bg-gradient-card border-border/50",children:e.jsx(h,{className:"p-6",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsx("p",{className:"text-sm font-medium text-muted-foreground",children:"Monthly Spending"}),e.jsxs("p",{className:"text-2xl font-bold text-foreground",children:["GHS ",H]})]}),e.jsx(B,{className:"h-8 w-8 text-white",strokeWidth:1})]})})}),e.jsx(x,{className:"bg-gradient-card border-border/50",children:e.jsx(h,{className:"p-6",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsx("p",{className:"text-sm font-medium text-muted-foreground",children:"Member Since"}),e.jsx("p",{className:"text-2xl font-bold text-foreground",children:"Jan 2024"})]}),e.jsx(ye,{className:"h-8 w-8 text-white",strokeWidth:1})]})})})]}),e.jsx("div",{className:"space-y-4 sm:space-y-6",children:e.jsxs(Ne,{value:g,onValueChange:o,className:"space-y-6",children:[e.jsxs(ve,{className:"mb-6",children:[e.jsxs(P,{value:"active",children:[e.jsx("span",{className:"sm:hidden",children:"Active Subs"}),e.jsx("span",{className:"hidden sm:inline",children:"Active Subscriptions"}),e.jsx("span",{className:"ml-2 text-xs opacity-70",children:k.length})]}),e.jsxs(P,{value:"inactive",children:[e.jsx("span",{className:"sm:hidden",children:"Inactive Subs"}),e.jsx("span",{className:"hidden sm:inline",children:"Inactive Subscriptions"}),e.jsx("span",{className:"ml-2 text-xs opacity-70",children:b.length})]}),e.jsxs(P,{value:"history",children:["Payment History",e.jsx("span",{className:"ml-2 text-xs opacity-70",children:S.length})]})]}),g==="active"&&e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"flex items-center justify-between",children:e.jsxs("h2",{className:"text-lg sm:text-xl font-semibold",children:["Active Subscriptions (",i?"...":k.length,")"]})}),i?e.jsx("div",{className:"flex justify-center py-8",children:e.jsx(J,{})}):c?e.jsx("div",{className:"text-center py-8 text-muted-foreground",children:e.jsxs("p",{children:["Error loading subscriptions: ",c]})}):k.length===0?e.jsxs("div",{className:"text-center py-8 text-muted-foreground",children:[e.jsx("p",{children:"No active subscriptions yet."}),e.jsx(y,{variant:"premium",className:"mt-4",asChild:!0,children:e.jsx(ke,{to:"/explore",children:"Discover Creators"})})]}):k.map(r=>e.jsx(fe,{subscription:r,onPauseResume:A,onCancel:T,onToggleAutoRenew:E,onSubscriptionUpdate:C},r.id))]}),g==="inactive"&&e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"flex items-center justify-between",children:e.jsxs("h2",{className:"text-lg sm:text-xl font-semibold",children:["Inactive Subscriptions (",i?"...":b.length,")"]})}),i?e.jsx("div",{className:"flex justify-center py-8",children:e.jsx(J,{})}):c?e.jsx("div",{className:"text-center py-8 text-muted-foreground",children:e.jsxs("p",{children:["Error loading subscriptions: ",c]})}):b.length===0?e.jsx("div",{className:"text-center py-8 text-muted-foreground",children:e.jsx("p",{children:"No inactive subscriptions."})}):b.map(r=>e.jsx(fe,{subscription:r,onPauseResume:A,onCancel:T,onToggleAutoRenew:E,onSubscriptionUpdate:C},r.id))]}),g==="history"&&e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"flex items-center justify-between",children:e.jsxs("h2",{className:"text-lg sm:text-xl font-semibold",children:["Payment History (",i?"...":S.length,")"]})}),i?e.jsx("div",{className:"flex justify-center py-8",children:e.jsx(J,{})}):c?e.jsx("div",{className:"text-center py-8 text-muted-foreground",children:e.jsxs("p",{children:["Error loading payment history: ",c]})}):S.length===0?e.jsx("div",{className:"text-center py-8 text-muted-foreground",children:e.jsx("p",{children:"No payment history yet."})}):e.jsx("div",{className:"space-y-4",children:S.map(r=>{var d;return e.jsx(x,{className:"bg-gradient-card border-border/50",children:e.jsx(h,{className:"p-4 sm:p-6",children:e.jsxs("div",{className:"flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4",children:[e.jsxs("div",{className:"flex items-start gap-3 sm:gap-4",children:[e.jsx("div",{className:"w-12 h-12 sm:w-16 sm:h-16 rounded-full overflow-hidden flex-shrink-0",children:r.creator.avatar?e.jsx("img",{src:r.creator.avatar,alt:r.creator.display_name,className:"w-full h-full object-cover"}):e.jsx("div",{className:"w-full h-full bg-gradient-to-br from-primary/20 to-accent/20 flex items-center justify-center",children:e.jsx("span",{className:"text-foreground font-medium text-sm sm:text-base",children:((d=r.creator.display_name)==null?void 0:d.charAt(0))||r.creator.username.charAt(0)})})}),e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsx("h3",{className:"font-semibold text-foreground text-sm sm:text-base",children:r.creator.display_name||r.creator.username}),e.jsxs("p",{className:"text-xs sm:text-sm text-muted-foreground",children:["@",r.creator.username]}),e.jsxs("p",{className:"text-xs sm:text-sm text-muted-foreground mt-1",children:[r.tier.name," • GHS ",r.tier.price,"/month"]}),e.jsx("div",{className:"flex items-center gap-2 mt-2",children:e.jsx(p,{variant:r.status==="active"?"success":r.status==="cancelled"||r.status==="expired"?"destructive":"secondary",className:"text-xs",children:r.status.charAt(0).toUpperCase()+r.status.slice(1)})})]})]}),e.jsx("div",{className:"text-right",children:e.jsxs("div",{className:"text-xs sm:text-sm text-muted-foreground",children:[e.jsxs("p",{children:["Subscribed: ",new Date(r.created_at).toLocaleDateString()]}),e.jsxs("p",{children:["Ended: ",new Date(r.next_billing_date).toLocaleDateString()]})]})})]})})},r.id)})})]})]})})]})})};export{Be as ManageSubscriptions};
