import{a as se,b as te,u as ae,r as a,j as e,C as R,d as _,e as L,f as B,g as $,h as G,I as z,a7 as re,B as u,a0 as ie}from"./index-DnjzDop3.js";import{T as le}from"./textarea-ChWCN1Go.js";import{S as oe,a as ne,b as de,c as ce,d as H}from"./select-BgAE-lOE.js";import{P as ue,a as he,f as me,b as pe,C as xe}from"./popover-C4xVhWYM.js";import{o as fe,s as T,f as je,u as ge,F as ve,a as v,b,e as y,c as w,d as S,t as be}from"./form-ZwPv4Ajc.js";import{I as ye}from"./image-DUscFDhE.js";import{V as we}from"./video-DbSLhckN.js";import{C as Se}from"./calendar-We5RV4OF.js";import"./chevron-up-CD9nw7va.js";const Ce=16*1024*1024,Pe=["image/jpeg","image/jpg","image/png","image/gif"],Ne=["video/mp4","video/mov"],Te=fe({caption:T().optional(),accessTier:T().min(1,"Please select who can see this post"),scheduledDate:je().optional(),scheduledTime:T().optional()}),_e=()=>{const{toast:r}=se(),p=te(),{user:i}=ae(),[c,D]=a.useState(null),[x,F]=a.useState(null),[C,E]=a.useState(null),[f,I]=a.useState(!1),[q,M]=a.useState(!1),[Y,k]=a.useState(!1),[J,V]=a.useState(!1),[W,P]=a.useState([]),[De,X]=a.useState(null),[Fe,Z]=a.useState(null),l=ge({resolver:be(Te),defaultValues:{caption:"",accessTier:"",scheduledTime:""}});a.useEffect(()=>{(async()=>{if(i!=null&&i.id)try{const s=await fetch(`/api/creators/${i.id}/tiers`);if(s.ok){const n=await s.json();P(n)}else console.error("Failed to fetch tiers"),P([])}catch(s){console.error("Error fetching tiers:",s),P([])}})()},[i==null?void 0:i.id]);const K=t=>{var h;const s=(h=t.target.files)==null?void 0:h[0];if(!s)return;if(s.size>Ce){r({title:"File too large",description:"Please select a file smaller than 16MB.",variant:"destructive"});return}const n=Pe.includes(s.type),j=Ne.includes(s.type);if(!n&&!j){r({title:"Invalid file type",description:"Please select a valid image (.jpg, .png, .gif) or video (.mp4, .mov) file.",variant:"destructive"});return}D(s),E(n?"image":"video");const d=URL.createObjectURL(s);F(d),r({title:"Media uploaded",description:`${s.name} has been selected successfully.`})},Q=()=>{x&&URL.revokeObjectURL(x),D(null),F(null),E(null),X(null),Z(null)},N=async(t,s)=>{var n,j;if(!((n=t.caption)!=null&&n.trim())&&!c){r({title:"Content required",description:"Please provide a caption or upload media to create a post.",variant:"destructive"});return}if(s==="schedule"&&!t.scheduledDate){r({title:"Schedule date required",description:"Please select a date and time to schedule your post.",variant:"destructive"});return}I(!0),s==="draft"?M(!0):s==="publish"?k(!0):s==="schedule"&&V(!0);try{if(!i){r({title:"Authentication required",description:"Please log in to create a post.",variant:"destructive"}),p("/login");return}let d=[];if(c)try{const o=new FormData;o.append("media",c);const m=await fetch("/api/upload/post-media",{method:"POST",body:o});if(!m.ok){const ee=await m.json();throw new Error(ee.error||"Failed to upload media")}const g=await m.json();if(d=g.filename?[g.filename]:[],d.length===0)throw new Error("Media upload did not return a valid filename")}catch(o){console.error("Media upload error:",o),r({title:"Media upload failed",description:o instanceof Error?o.message:"Please try uploading again.",variant:"destructive"});return}let h=null;if(t.scheduledDate&&s==="schedule"){const o=new Date(t.scheduledDate);if(t.scheduledTime){const[m,g]=t.scheduledTime.split(":");o.setHours(parseInt(m),parseInt(g),0,0)}h=o.toISOString()}const U={creator_id:parseInt(i.id),title:((j=t.caption)==null?void 0:j.substring(0,50))||"Untitled Post",content:t.caption||"",media_type:C||"text",media_urls:d,tier:t.accessTier==="free"?"public":t.accessTier,status:s==="draft"?"draft":s==="schedule"?"scheduled":"published",scheduled_for:h};console.log("Creating post with data:",U);const A=await fetch("/api/posts",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(U)});if(!A.ok)throw new Error("Failed to create post");const O=await A.json();console.log("Post created successfully:",O),window.dispatchEvent(new CustomEvent("localStorageChange",{detail:{type:"postCreated",post:O}})),r({title:`Post ${s==="publish"?"published":s==="schedule"?"scheduled":"saved as draft"}`,description:`Your post has been ${s==="publish"?"published successfully":s==="schedule"?"scheduled successfully":"saved as draft"}.`}),p(s==="schedule"?"/creator/schedule":"/creator/dashboard")}catch(d){console.error("Error creating post:",d),r({title:"Error",description:`Failed to ${s} post. Please try again.`,variant:"destructive"})}finally{I(!1),M(!1),k(!1),V(!1)}};return e.jsx("div",{className:"min-h-screen bg-background",children:e.jsxs("div",{className:"max-w-4xl mx-auto px-4 sm:px-6 lg:px-8 py-8",children:[e.jsxs("div",{className:"mb-6 sm:mb-8 text-center sm:text-left",children:[e.jsx("h1",{className:"text-2xl sm:text-3xl font-bold text-foreground mb-2 flex items-center gap-2 justify-center sm:justify-start",children:"Create New Post"}),e.jsx("p",{className:"text-sm sm:text-base text-muted-foreground",children:"Share exclusive content with your subscribers"})]}),e.jsx(ve,{...l,children:e.jsxs("form",{className:"space-y-6",children:[e.jsxs(R,{className:"bg-gradient-card border-border/50",children:[e.jsxs(_,{children:[e.jsx(L,{children:"Post Content"}),e.jsx(B,{children:"Add your caption and media"})]}),e.jsxs($,{className:"space-y-6",children:[e.jsx(v,{control:l.control,name:"caption",render:({field:t})=>e.jsxs(b,{children:[e.jsx(y,{children:"Caption"}),e.jsx(w,{children:e.jsx(le,{placeholder:"What's on your mind?",className:"min-h-[120px] resize-none",...t})}),e.jsx(S,{})]})}),e.jsxs("div",{className:"space-y-4",children:[e.jsx(G,{children:"Media (Optional)"}),c?e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"relative rounded-lg overflow-hidden bg-muted",children:[C==="image"?e.jsx("img",{src:x,alt:"Preview",className:"w-full h-64 object-cover"}):e.jsx("video",{src:x,className:"w-full h-64 object-cover",controls:!0}),e.jsx("div",{className:"absolute top-2 right-2",children:e.jsx(u,{type:"button",variant:"destructive",size:"sm",onClick:Q,children:"Remove"})})]}),e.jsxs("div",{className:"flex items-center gap-2 text-sm text-muted-foreground",children:[C==="image"?e.jsx(ye,{className:"w-4 h-4"}):e.jsx(we,{className:"w-4 h-4"}),e.jsxs("span",{children:[c.name," (",(c.size/1024/1024).toFixed(1)," MB)"]})]})]}):e.jsxs("div",{className:"border-2 border-dashed border-border rounded-lg p-8 text-center",children:[e.jsx(z,{type:"file",accept:".jpg,.jpeg,.png,.gif,.mp4,.mov",onChange:K,className:"hidden",id:"media-upload"}),e.jsx(G,{htmlFor:"media-upload",className:"cursor-pointer",children:e.jsxs("div",{className:"flex flex-col items-center gap-4",children:[e.jsx(re,{className:"w-12 h-12 text-muted-foreground"}),e.jsxs("div",{children:[e.jsx("p",{className:"text-sm font-medium",children:"Click to upload media"}),e.jsxs("p",{className:"text-xs text-muted-foreground",children:["Images: JPG, PNG, GIF (max 16MB)",e.jsx("br",{}),"Videos: MP4, MOV (max 16MB)"]})]})]})})]})]})]})]}),e.jsxs(R,{className:"bg-gradient-card border-border/50",children:[e.jsxs(_,{children:[e.jsx(L,{children:"Audience & Publishing"}),e.jsx(B,{children:"Choose who can see this post and when to publish"})]}),e.jsxs($,{className:"space-y-6",children:[e.jsx(v,{control:l.control,name:"accessTier",render:({field:t})=>e.jsxs(b,{children:[e.jsx(y,{children:"Choose who can see this post"}),e.jsxs(oe,{onValueChange:t.onChange,defaultValue:t.value,children:[e.jsx(w,{children:e.jsx(ne,{children:e.jsx(de,{placeholder:"Select access level"})})}),e.jsxs(ce,{children:[e.jsx(H,{value:"free",children:"Free for all followers"}),W.map(s=>e.jsxs(H,{value:s.name,children:[s.name," (GHS ",s.price,"/month)"]},s.id))]})]}),e.jsx(S,{})]})}),e.jsxs("div",{className:"grid md:grid-cols-2 gap-4",children:[e.jsx(v,{control:l.control,name:"scheduledDate",render:({field:t})=>e.jsxs(b,{className:"flex flex-col",children:[e.jsx(y,{children:"Schedule Date (Optional)"}),e.jsxs(ue,{children:[e.jsx(he,{asChild:!0,children:e.jsx(w,{children:e.jsxs(u,{variant:"outline",className:ie("w-full pl-3 text-left font-normal",!t.value&&"text-muted-foreground"),children:[t.value?me(t.value,"PPP"):e.jsx("span",{children:"Pick a date"}),e.jsx(Se,{className:"ml-auto h-4 w-4 opacity-50"})]})})}),e.jsx(pe,{className:"w-auto p-0",align:"start",children:e.jsx(xe,{mode:"single",selected:t.value,onSelect:t.onChange,disabled:s=>s<new Date(new Date().setHours(0,0,0,0)),initialFocus:!0})})]}),e.jsx(S,{})]})}),e.jsx(v,{control:l.control,name:"scheduledTime",render:({field:t})=>e.jsxs(b,{children:[e.jsx(y,{children:"Schedule Time"}),e.jsx(w,{children:e.jsx(z,{type:"time",...t})}),e.jsx(S,{})]})})]})]})]}),e.jsxs("div",{className:"flex flex-col sm:flex-row gap-4 justify-end",children:[e.jsx(u,{type:"button",variant:"outline",onClick:()=>p("/creator/dashboard"),disabled:f,children:"Cancel"}),e.jsx(u,{type:"button",variant:"secondary",onClick:()=>l.handleSubmit(t=>N(t,"draft"))(),disabled:f,children:q?"Saving...":"Save as Draft"}),e.jsx(u,{type:"button",variant:"outline",onClick:()=>l.handleSubmit(t=>N(t,"schedule"))(),disabled:f||!l.watch("scheduledDate"),children:J?"Scheduling...":"Schedule Post"}),e.jsx(u,{type:"button",onClick:()=>l.handleSubmit(t=>N(t,"publish"))(),disabled:f,children:Y?"Publishing...":"Publish Now"})]})]})})]})})};export{_e as CreatePost};
